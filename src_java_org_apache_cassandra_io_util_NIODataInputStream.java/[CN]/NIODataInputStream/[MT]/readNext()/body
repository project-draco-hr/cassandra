{
  Preconditions.checkState(buf.remaining() != buf.capacity());
  assert(buf.remaining() < 8);
  if (buf.position() == 0 && buf.hasRemaining()) {
    buf.position(buf.limit());
  }
 else   if (buf.hasRemaining()) {
    ByteBuffer dup=buf.duplicate();
    buf.clear();
    buf.put(dup);
  }
 else {
    buf.position(0);
  }
  buf.limit(buf.capacity());
  int read=0;
  while ((read=rbc.read(buf)) == 0) {
  }
  buf.flip();
  return read;
}
