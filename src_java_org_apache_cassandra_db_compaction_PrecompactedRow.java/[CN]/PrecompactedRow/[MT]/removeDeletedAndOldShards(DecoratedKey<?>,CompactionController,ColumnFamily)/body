{
  Boolean shouldPurge=null;
  if (cf.hasExpiredTombstones(controller.gcBefore))   shouldPurge=controller.shouldPurge(key);
  ColumnFamily compacted=ColumnFamilyStore.removeDeleted(cf,shouldPurge != null && shouldPurge ? controller.gcBefore : Integer.MIN_VALUE);
  if (compacted != null && compacted.metadata().getDefaultValidator().isCommutative()) {
    if (shouldPurge == null)     shouldPurge=controller.shouldPurge(key);
    if (shouldPurge)     CounterColumn.mergeAndRemoveOldShards(key,compacted,controller.gcBefore,controller.mergeShardBefore);
  }
  return compacted;
}
