{
  Boolean shouldPurge=null;
  if (cf.hasExpiredTombstones(controller.gcBefore))   shouldPurge=controller.shouldPurge(key);
  ColumnFamily compacted=shouldPurge != null && shouldPurge ? ColumnFamilyStore.removeDeleted(cf,controller.gcBefore) : cf;
  if (compacted != null && compacted.metadata().getDefaultValidator().isCommutative()) {
    if (shouldPurge == null)     shouldPurge=controller.shouldPurge(key);
    if (shouldPurge)     CounterColumn.mergeAndRemoveOldShards(key,compacted,controller.gcBefore,controller.mergeShardBefore);
  }
  return compacted;
}
