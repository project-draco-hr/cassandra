{
  KSMetaData oldKsm=Schema.instance.getKSMetaData(newState.name);
  RowMutation mutation=null;
  if (withSchemaRecord) {
    mutation=oldKsm.diff(newState,timestamp);
    mutation.apply();
  }
  KSMetaData newKsm=KSMetaData.cloneWith(oldKsm.reloadAttributes(),oldKsm.cfMetaData().values());
  Schema.instance.setTableDefinition(newKsm);
  if (!StorageService.instance.isClientMode())   Table.open(newState.name).createReplicationStrategy(newKsm);
  return mutation;
}
