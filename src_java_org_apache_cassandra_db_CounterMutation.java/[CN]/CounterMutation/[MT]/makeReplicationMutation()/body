{
  List<ReadCommand> readCommands=new LinkedList<ReadCommand>();
  for (  ColumnFamily columnFamily : rowMutation.getColumnFamilies()) {
    if (!columnFamily.metadata().getReplicateOnWrite())     continue;
    addReadCommandFromColumnFamily(rowMutation.getTable(),rowMutation.key(),columnFamily,readCommands);
  }
  RowMutation replicationMutation=new RowMutation(rowMutation.getTable(),rowMutation.key());
  for (  ReadCommand readCommand : readCommands) {
    Table table=Table.open(readCommand.table);
    Row row=readCommand.getRow(table);
    if (row == null || row.cf == null)     continue;
    row=mergeOldShards(readCommand.table,row);
    ColumnFamily cf=row.cf;
    if (cf.isSuper())     cf.retainAll(rowMutation.getColumnFamily(cf.metadata().cfId));
    replicationMutation.add(cf);
  }
  return replicationMutation;
}
