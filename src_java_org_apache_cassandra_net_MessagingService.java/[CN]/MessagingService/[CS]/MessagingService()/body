{
  for (  StorageService.Verb verb : DROPPABLE_VERBS) {
    droppedMessages.put(verb,new AtomicInteger());
    lastDropped.put(verb,0);
    lastDroppedInternal.put(verb,0);
  }
  listenGate=new SimpleCondition();
  verbHandlers_=new EnumMap<StorageService.Verb,IVerbHandler>(StorageService.Verb.class);
  streamExecutor_=new DebuggableThreadPoolExecutor("Streaming",DatabaseDescriptor.getCompactionThreadPriority());
  Runnable logDropped=new Runnable(){
    public void run(){
      logDroppedMessages();
    }
  }
;
  StorageService.scheduledTasks.scheduleWithFixedDelay(logDropped,LOG_DROPPED_INTERVAL_IN_MS,LOG_DROPPED_INTERVAL_IN_MS,TimeUnit.MILLISECONDS);
  Function<Pair<String,Pair<InetAddress,IMessageCallback>>,?> timeoutReporter=new Function<Pair<String,Pair<InetAddress,IMessageCallback>>,Object>(){
    public Object apply(    Pair<String,Pair<InetAddress,IMessageCallback>> pair){
      Pair<InetAddress,IMessageCallback> expiredValue=pair.right;
      maybeAddLatency(expiredValue.right,expiredValue.left,(double)DatabaseDescriptor.getRpcTimeout());
      totalTimeouts++;
      String ip=expiredValue.left.getHostAddress();
      AtomicLong c=timeoutsPerHost.get(ip);
      if (c == null)       c=timeoutsPerHost.put(ip,new AtomicLong());
      c.incrementAndGet();
      if (recentTimeoutsPerHost.get(ip) == null)       recentTimeoutsPerHost.put(ip,new AtomicLong());
      return null;
    }
  }
;
  callbacks=new ExpiringMap<String,Pair<InetAddress,IMessageCallback>>(DEFAULT_CALLBACK_TIMEOUT,timeoutReporter);
  MBeanServer mbs=ManagementFactory.getPlatformMBeanServer();
  try {
    mbs.registerMBean(this,new ObjectName(MBEAN_NAME));
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
}
