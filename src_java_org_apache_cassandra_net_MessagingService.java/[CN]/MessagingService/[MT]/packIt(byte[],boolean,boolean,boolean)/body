{
  byte[] size=toByteArray(bytes.length);
  int n=0;
  n|=serializerType_.ordinal();
  if (compress)   n|=4;
  if (stream)   n|=8;
  if (listening)   n|=16;
  n|=(version_ << 8);
  byte[] header=toByteArray(n);
  ByteBuffer buffer=ByteBuffer.allocate(16 + header.length + size.length+ bytes.length);
  buffer.put(protocol_);
  buffer.put(header);
  buffer.put(size);
  buffer.put(bytes);
  buffer.flip();
  return buffer;
}
