{
  Map<String,EndPoint> suitableEndPoints=new HashMap<String,EndPoint>();
  Map<String,EndPoint[]> results=getNStorageEndPoints(keys);
  for (  String key : keys) {
    EndPoint[] endpoints=results.get(key);
    boolean moveOn=false;
    for (    EndPoint endPoint : endpoints) {
      if (endPoint.equals(StorageService.getLocalStorageEndPoint())) {
        suitableEndPoints.put(key,endPoint);
        moveOn=true;
        break;
      }
    }
    if (moveOn)     continue;
    int j=0;
    for (; j < endpoints.length; ++j) {
      if (StorageService.instance().isInSameDataCenter(endpoints[j]) && FailureDetector.instance().isAlive(endpoints[j])) {
        if (logger_.isDebugEnabled())         logger_.debug("EndPoint " + endpoints[j] + " is in the same data center as local storage endpoint.");
        suitableEndPoints.put(key,endpoints[j]);
        moveOn=true;
        break;
      }
    }
    if (moveOn)     continue;
    j=0;
    for (; j < endpoints.length; ++j) {
      if (FailureDetector.instance().isAlive(endpoints[j])) {
        if (logger_.isDebugEnabled())         logger_.debug("EndPoint " + endpoints[j] + " is alive so get data from it.");
        suitableEndPoints.put(key,endpoints[j]);
        break;
      }
    }
  }
  return suitableEndPoints;
}
