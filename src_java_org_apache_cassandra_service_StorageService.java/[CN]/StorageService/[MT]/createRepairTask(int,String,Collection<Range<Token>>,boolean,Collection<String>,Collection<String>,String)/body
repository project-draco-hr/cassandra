{
  if (dataCenters != null && !dataCenters.contains(DatabaseDescriptor.getLocalDataCenter())) {
    throw new IllegalArgumentException("the local data center must be part of the repair");
  }
  return new FutureTask<>(new WrappedRunnable(){
    protected void runMayThrow() throws Exception {
      String message=String.format("Starting repair command #%d, repairing %d ranges for keyspace %s",cmd,ranges.size(),keyspace);
      logger.info(message);
      sendNotification("repair",message,new int[]{cmd,ActiveRepairService.Status.STARTED.ordinal()});
      List<RepairFuture> futures=new ArrayList<>(ranges.size());
      for (      Range<Token> range : ranges) {
        RepairFuture future;
        try {
          future=forceKeyspaceRepair(range,keyspace,isSequential,dataCenters,hosts,columnFamilies);
        }
 catch (        IllegalArgumentException e) {
          logger.error("Repair session failed:",e);
          sendNotification("repair",e.getMessage(),new int[]{cmd,ActiveRepairService.Status.SESSION_FAILED.ordinal()});
          continue;
        }
        if (future == null)         continue;
        futures.add(future);
        try {
          future.session.differencingDone.await();
        }
 catch (        InterruptedException e) {
          message="Interrupted while waiting for the differencing of repair session " + future.session + " to be done. Repair may be imprecise.";
          logger.error(message,e);
          sendNotification("repair",message,new int[]{cmd,ActiveRepairService.Status.SESSION_FAILED.ordinal()});
        }
      }
      for (      RepairFuture future : futures) {
        try {
          future.get();
          message=String.format("Repair session %s for range %s finished",future.session.getId(),future.session.getRange().toString());
          logger.info(message);
          sendNotification("repair",message,new int[]{cmd,ActiveRepairService.Status.SESSION_SUCCESS.ordinal()});
        }
 catch (        ExecutionException e) {
          message=String.format("Repair session %s for range %s failed with error %s",future.session.getId(),future.session.getRange().toString(),e.getCause().getMessage());
          logger.error(message,e);
          sendNotification("repair",message,new int[]{cmd,ActiveRepairService.Status.SESSION_FAILED.ordinal()});
        }
catch (        Exception e) {
          message=String.format("Repair session %s for range %s failed with error %s",future.session.getId(),future.session.getRange().toString(),e.getMessage());
          logger.error(message,e);
          sendNotification("repair",message,new int[]{cmd,ActiveRepairService.Status.SESSION_FAILED.ordinal()});
        }
      }
      sendNotification("repair",String.format("Repair command #%d finished",cmd),new int[]{cmd,ActiveRepairService.Status.FINISHED.ordinal()});
    }
  }
,null);
}
