{
  logger.info("Gathering node replacement information for {}",DatabaseDescriptor.getReplaceAddress());
  if (!MessagingService.instance().isListening())   MessagingService.instance().listen();
  Gossiper.instance.doShadowRound();
  if (Gossiper.instance.getEndpointStateForEndpoint(DatabaseDescriptor.getReplaceAddress()) == null)   throw new RuntimeException("Cannot replace_address " + DatabaseDescriptor.getReplaceAddress() + " because it doesn't exist in gossip");
  replacingId=Gossiper.instance.getHostId(DatabaseDescriptor.getReplaceAddress());
  try {
    VersionedValue tokensVersionedValue=Gossiper.instance.getEndpointStateForEndpoint(DatabaseDescriptor.getReplaceAddress()).getApplicationState(ApplicationState.TOKENS);
    if (tokensVersionedValue == null)     throw new RuntimeException("Could not find tokens for " + DatabaseDescriptor.getReplaceAddress() + " to replace");
    Collection<Token> tokens=TokenSerializer.deserialize(getPartitioner(),new DataInputStream(new ByteArrayInputStream(tokensVersionedValue.toBytes())));
    if (isReplacingSameAddress()) {
      SystemKeyspace.setLocalHostId(replacingId);
    }
    Gossiper.instance.resetEndpointStateMap();
    return tokens;
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
