{
  Collection<Range<Token>> ranges=getRangesForEndpoint(table,endpoint);
  if (logger_.isDebugEnabled())   logger_.debug("Node " + endpoint + " ranges ["+ StringUtils.join(ranges,", ")+ "]");
  Map<Range<Token>,List<InetAddress>> currentReplicaEndpoints=new HashMap<Range<Token>,List<InetAddress>>();
  for (  Range<Token> range : ranges)   currentReplicaEndpoints.put(range,Table.open(table).getReplicationStrategy().calculateNaturalEndpoints(range.right,tokenMetadata_));
  TokenMetadata temp=tokenMetadata_.cloneAfterAllLeft();
  if (temp.isMember(endpoint))   temp.removeEndpoint(endpoint);
  Multimap<Range<Token>,InetAddress> changedRanges=HashMultimap.create();
  for (  Range<Token> range : ranges) {
    Collection<InetAddress> newReplicaEndpoints=Table.open(table).getReplicationStrategy().calculateNaturalEndpoints(range.right,temp);
    newReplicaEndpoints.removeAll(currentReplicaEndpoints.get(range));
    if (logger_.isDebugEnabled())     if (newReplicaEndpoints.isEmpty())     logger_.debug("Range " + range + " already in all replicas");
 else     logger_.debug("Range " + range + " will be responsibility of "+ StringUtils.join(newReplicaEndpoints,", "));
    changedRanges.putAll(range,newReplicaEndpoints);
  }
  return changedRanges;
}
