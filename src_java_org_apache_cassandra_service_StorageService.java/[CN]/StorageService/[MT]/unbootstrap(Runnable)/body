{
  Map<String,Multimap<Range<Token>,InetAddress>> rangesToStream=new HashMap<String,Multimap<Range<Token>,InetAddress>>();
  for (  final String table : Schema.instance.getNonSystemTables()) {
    Multimap<Range<Token>,InetAddress> rangesMM=getChangedRangesForLeaving(table,FBUtilities.getBroadcastAddress());
    if (logger.isDebugEnabled())     logger.debug("Ranges needing transfer are [" + StringUtils.join(rangesMM.keySet(),",") + "]");
    rangesToStream.put(table,rangesMM);
  }
  setMode(Mode.LEAVING,"streaming data to other nodes",true);
  Future<StreamState> streamSuccess=streamRanges(rangesToStream);
  Future<StreamState> hintsSuccess=streamHints();
  logger.debug("waiting for stream aks.");
  try {
    streamSuccess.get();
    hintsSuccess.get();
  }
 catch (  ExecutionException|InterruptedException e) {
    throw new RuntimeException(e);
  }
  logger.debug("stream acks all received.");
  leaveRing();
  onFinish.run();
}
