{
  Map<String,Multimap<Range,InetAddress>> rangesToStream=new HashMap<String,Multimap<Range,InetAddress>>();
  for (  final String table : DatabaseDescriptor.getNonSystemTables()) {
    Multimap<Range,InetAddress> rangesMM=getChangedRangesForLeaving(table,FBUtilities.getLocalAddress());
    if (logger_.isDebugEnabled())     logger_.debug("Ranges needing transfer are [" + StringUtils.join(rangesMM.keySet(),",") + "]");
    rangesToStream.put(table,rangesMM);
  }
  setMode("Leaving: streaming data to other nodes",true);
  CountDownLatch latch=streamRanges(rangesToStream);
  logger_.debug("waiting for stream aks.");
  try {
    latch.await();
  }
 catch (  InterruptedException e) {
    throw new RuntimeException(e);
  }
  logger_.debug("stream acks all received.");
  leaveRing();
  onFinish.run();
}
