{
  ApplicationState nodeIdState=epState.getApplicationState(StorageService.NODE_ID);
  ApplicationState modeState=epState.getApplicationState(StorageService.MODE);
  if (modeState != null) {
    String mode=modeState.getState();
    if (logger_.isDebugEnabled())     logger_.debug(endpoint + " is in " + mode+ " mode");
    boolean bootstrapState=mode.equals(MODE_MOVING);
    tokenMetadata_.setBootstrapping(endpoint,bootstrapState);
  }
  if (nodeIdState == null) {
    if (epState.isAlive() && tokenMetadata_.isMember(endpoint)) {
      if (logger_.isDebugEnabled())       logger_.debug("InetAddress " + endpoint + " just recovered from a partition. Sending hinted data.");
      deliverHints(endpoint);
    }
  }
 else {
    Token newToken=getPartitioner().getTokenFactory().fromString(nodeIdState.getState());
    if (logger_.isDebugEnabled())     logger_.debug("CHANGE IN STATE FOR " + endpoint + " - has token "+ nodeIdState.getState());
    if (tokenMetadata_.isMember(endpoint)) {
      Token oldToken=tokenMetadata_.getToken(endpoint);
      if (!oldToken.equals(newToken)) {
        if (logger_.isDebugEnabled())         logger_.debug("Relocation for endpoint " + endpoint);
        updateForeignToken(newToken,endpoint);
      }
 else {
        if (logger_.isDebugEnabled())         logger_.debug("Sending hinted data to " + endpoint);
        deliverHints(endpoint);
      }
    }
 else {
      updateForeignToken(newToken,endpoint);
    }
  }
}
