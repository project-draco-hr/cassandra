{
  ApplicationState nodeIdState=epState.getApplicationState(StorageService.NODE_ID);
  boolean bootstrapState=epState.getApplicationState(StorageService.BOOTSTRAP_MODE) != null;
  if (bootstrapState) {
    if (logger_.isDebugEnabled())     logger_.debug(endpoint + " is in bootstrap state.");
  }
  if (nodeIdState != null) {
    Token newToken=getPartitioner().getTokenFactory().fromString(nodeIdState.getState());
    if (logger_.isDebugEnabled())     logger_.debug("CHANGE IN STATE FOR " + endpoint + " - has token "+ nodeIdState.getState());
    Token oldToken=tokenMetadata_.getToken(endpoint);
    if (oldToken != null) {
      if (!oldToken.equals(newToken)) {
        if (logger_.isDebugEnabled())         logger_.debug("Relocation for endpoint " + endpoint);
        updateTokenMetadata(newToken,endpoint,bootstrapState);
      }
 else {
        if (logger_.isDebugEnabled())         logger_.debug("Sending hinted data to " + endpoint);
        deliverHints(endpoint);
      }
    }
 else {
      updateTokenMetadata(newToken,endpoint,bootstrapState);
    }
  }
 else {
    if (epState.isAlive() && tokenMetadata_.isKnownEndPoint(endpoint)) {
      if (logger_.isDebugEnabled())       logger_.debug("InetAddress " + endpoint + " just recovered from a partition. Sending hinted data.");
      deliverHints(endpoint);
    }
  }
}
