{
  for (  String table : DatabaseDescriptor.getTables()) {
    if (tokenMetadata_.getPendingRanges(table,FBUtilities.getLocalAddress()).size() > 0)     throw new UnsupportedOperationException("data is currently moving to this node; unable to leave the ring");
  }
  if (token != null && tokenMetadata_.sortedTokens().contains(token))   throw new IOException("target token " + token + " is already owned by another node");
  if (logger_.isDebugEnabled())   logger_.debug("Leaving: old token was " + getLocalToken());
  startLeaving();
  setMode("Leaving: sleeping " + RING_DELAY + " for pending range setup",true);
  Thread.sleep(RING_DELAY);
  Runnable finishMoving=new WrappedRunnable(){
    public void runMayThrow() throws IOException {
      Token bootstrapToken=token;
      if (bootstrapToken == null) {
        StorageLoadBalancer.instance.waitForLoadInfo();
        bootstrapToken=BootStrapper.getBalancedToken(tokenMetadata_,StorageLoadBalancer.instance.getLoadInfo());
      }
      logger_.info("re-bootstrapping to new token {}",bootstrapToken);
      startBootstrap(bootstrapToken);
    }
  }
;
  unbootstrap(finishMoving);
}
