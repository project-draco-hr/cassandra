{
  while (true) {
    if (pool.tryAllocate(size)) {
      acquired(size);
      return;
    }
    WaitQueue.Signal signal=opGroup.isBlockingSignal(pool.hasRoom.register());
    boolean allocated=pool.tryAllocate(size);
    if (allocated || opGroup.isBlocking()) {
      signal.cancel();
      if (allocated)       acquired(size);
 else       allocated(size);
      return;
    }
 else     signal.awaitUninterruptibly();
  }
}
