{
  try {
    if (buffer.readableBytes() == 0)     return null;
    int firstByte=buffer.getByte(0);
    Message.Direction direction=Message.Direction.extractFromVersion(firstByte);
    int version=firstByte & 0x7F;
    if (version > Header.CURRENT_VERSION)     throw new ProtocolException("Invalid or unsupported protocol version: " + version);
    if (buffer.readableBytes() >= 4)     Message.Type.fromOpcode(buffer.getByte(3),direction);
    ChannelBuffer frame=(ChannelBuffer)super.decode(ctx,channel,buffer);
    if (frame == null) {
      return null;
    }
    Connection connection=(Connection)channel.getAttachment();
    if (connection == null) {
      connection=factory.newConnection(channel,version);
      channel.setAttachment(connection);
    }
 else     if (connection.getVersion() != version) {
      throw new ProtocolException(String.format("Invalid message version. Got %d but previous messages on this connection had version %d",version,connection.getVersion()));
    }
    return Frame.create(frame);
  }
 catch (  CorruptedFrameException e) {
    throw new ProtocolException(e.getMessage());
  }
catch (  TooLongFrameException e) {
    throw new ProtocolException(e.getMessage());
  }
}
