{
  StorageService ss=StorageService.instance;
  TokenMetadata tmd=ss.getTokenMetadata();
  tmd.clearUnsafe();
  IPartitioner partitioner=new RandomPartitioner();
  ApplicationState.ApplicationStateFactory stateFactory=new ApplicationState.ApplicationStateFactory(partitioner);
  IPartitioner oldPartitioner=ss.setPartitionerUnsafe(partitioner);
  ArrayList<Token> endpointTokens=new ArrayList<Token>();
  ArrayList<Token> keyTokens=new ArrayList<Token>();
  List<InetAddress> hosts=new ArrayList<InetAddress>();
  createInitialRing(ss,partitioner,endpointTokens,keyTokens,hosts,6);
  ss.onChange(hosts.get(2),ApplicationState.STATE_MOVE,stateFactory.leaving(keyTokens.get(0)));
  assertTrue(tmd.getToken(hosts.get(2)).equals(keyTokens.get(0)));
  assertTrue(tmd.isLeaving(hosts.get(2)));
  assertTrue(tmd.getEndpoint(endpointTokens.get(2)) == null);
  ss.onChange(hosts.get(2),ApplicationState.STATE_MOVE,stateFactory.bootstrapping(keyTokens.get(1)));
  assertFalse(tmd.isLeaving(hosts.get(2)));
  assertTrue(tmd.getBootstrapTokens().size() == 1);
  assertTrue(tmd.getBootstrapTokens().get(keyTokens.get(1)).equals(hosts.get(2)));
  ss.onChange(hosts.get(2),ApplicationState.STATE_MOVE,stateFactory.leaving(keyTokens.get(1)));
  assertTrue(tmd.getEndpoint(keyTokens.get(1)).equals(hosts.get(2)));
  assertTrue(tmd.isLeaving(hosts.get(2)));
  assertTrue(tmd.getBootstrapTokens().isEmpty());
  ss.onChange(hosts.get(2),ApplicationState.STATE_MOVE,stateFactory.left(keyTokens.get(1)));
  assertFalse(tmd.isMember(hosts.get(2)));
  assertFalse(tmd.isLeaving(hosts.get(2)));
  ss.setPartitionerUnsafe(oldPartitioner);
}
