{
  StorageService ss=StorageService.instance;
  TokenMetadata tmd=ss.getTokenMetadata();
  tmd.clearUnsafe();
  IPartitioner partitioner=new RandomPartitioner();
  AbstractReplicationStrategy testStrategy=new RackUnawareStrategy(tmd,3);
  IPartitioner oldPartitioner=ss.setPartitionerUnsafe(partitioner);
  AbstractReplicationStrategy oldStrategy=ss.setReplicationStrategyUnsafe(testStrategy);
  ArrayList<Token> endPointTokens=new ArrayList<Token>();
  ArrayList<Token> keyTokens=new ArrayList<Token>();
  List<InetAddress> hosts=new ArrayList<InetAddress>();
  createInitialRing(ss,partitioner,endPointTokens,keyTokens,hosts,5);
  ss.onChange(hosts.get(2),StorageService.MOVE_STATE,new ApplicationState(StorageService.STATE_LEAVING + StorageService.Delimiter + partitioner.getTokenFactory().toString(endPointTokens.get(2))));
  assertTrue(tmd.isMember(hosts.get(2)));
  assertTrue(tmd.isLeaving(hosts.get(2)));
  assertTrue(tmd.getBootstrapTokens().isEmpty());
  ss.onChange(hosts.get(2),StorageService.MOVE_STATE,new ApplicationState(StorageService.STATE_BOOTSTRAPPING + StorageService.Delimiter + partitioner.getTokenFactory().toString(keyTokens.get(4))));
  assertFalse(tmd.isMember(hosts.get(2)));
  assertFalse(tmd.isLeaving(hosts.get(2)));
  assertTrue(tmd.getBootstrapTokens().get(keyTokens.get(4)).equals(hosts.get(2)));
  ss.onChange(hosts.get(3),StorageService.MOVE_STATE,new ApplicationState(StorageService.STATE_BOOTSTRAPPING + StorageService.Delimiter + partitioner.getTokenFactory().toString(keyTokens.get(1))));
  assertFalse(tmd.isMember(hosts.get(3)));
  assertFalse(tmd.isLeaving(hosts.get(3)));
  assertTrue(tmd.getBootstrapTokens().get(keyTokens.get(4)).equals(hosts.get(2)));
  assertTrue(tmd.getBootstrapTokens().get(keyTokens.get(1)).equals(hosts.get(3)));
  ss.onChange(hosts.get(2),StorageService.MOVE_STATE,new ApplicationState(StorageService.STATE_BOOTSTRAPPING + StorageService.Delimiter + partitioner.getTokenFactory().toString(keyTokens.get(3))));
  assertFalse(tmd.isMember(hosts.get(2)));
  assertFalse(tmd.isLeaving(hosts.get(2)));
  assertTrue(tmd.getBootstrapTokens().get(keyTokens.get(3)).equals(hosts.get(2)));
  assertTrue(tmd.getBootstrapTokens().get(keyTokens.get(4)) == null);
  assertTrue(tmd.getBootstrapTokens().get(keyTokens.get(1)).equals(hosts.get(3)));
  ss.onChange(hosts.get(2),StorageService.MOVE_STATE,new ApplicationState(StorageService.STATE_NORMAL + StorageService.Delimiter + partitioner.getTokenFactory().toString(keyTokens.get(3))));
  ss.onChange(hosts.get(3),StorageService.MOVE_STATE,new ApplicationState(StorageService.STATE_NORMAL + StorageService.Delimiter + partitioner.getTokenFactory().toString(keyTokens.get(2))));
  assertTrue(tmd.isMember(hosts.get(2)));
  assertFalse(tmd.isLeaving(hosts.get(2)));
  assertTrue(tmd.getToken(hosts.get(2)).equals(keyTokens.get(3)));
  assertTrue(tmd.isMember(hosts.get(3)));
  assertFalse(tmd.isLeaving(hosts.get(3)));
  assertTrue(tmd.getToken(hosts.get(3)).equals(keyTokens.get(2)));
  assertTrue(tmd.getBootstrapTokens().isEmpty());
  ss.setPartitionerUnsafe(oldPartitioner);
  ss.setReplicationStrategyUnsafe(oldStrategy);
}
