{
  StorageService ss=StorageService.instance;
  final int RING_SIZE=10;
  TokenMetadata tmd=ss.getTokenMetadata();
  tmd.clearUnsafe();
  IPartitioner partitioner=new RandomPartitioner();
  VersionedValue.VersionedValueFactory valueFactory=new VersionedValue.VersionedValueFactory(partitioner);
  IPartitioner oldPartitioner=ss.setPartitionerUnsafe(partitioner);
  ArrayList<Token> endpointTokens=new ArrayList<Token>();
  ArrayList<Token> keyTokens=new ArrayList<Token>();
  List<InetAddress> hosts=new ArrayList<InetAddress>();
  Util.createInitialRing(ss,partitioner,endpointTokens,keyTokens,hosts,RING_SIZE);
  final int[] MOVING=new int[]{6,8,9};
  Map<Integer,Token> newTokens=new HashMap<Integer,Token>();
  for (  int movingIndex : MOVING) {
    Token newToken=positionToken(movingIndex);
    ss.onChange(hosts.get(movingIndex),ApplicationState.STATUS,valueFactory.moving(newToken));
    newTokens.put(movingIndex,newToken);
  }
  Collection<InetAddress> endpoints;
  tmd=tmd.cloneAfterAllSettled();
  ss.setTokenMetadataUnsafe(tmd);
  InetAddress boot1=InetAddress.getByName("127.0.1.1");
  ss.onChange(boot1,ApplicationState.STATUS,valueFactory.bootstrapping(keyTokens.get(5)));
  InetAddress boot2=InetAddress.getByName("127.0.1.2");
  ss.onChange(boot2,ApplicationState.STATUS,valueFactory.bootstrapping(keyTokens.get(7)));
  Map<String,AbstractReplicationStrategy> tableStrategyMap=new HashMap<String,AbstractReplicationStrategy>();
  for (int i=1; i <= 4; i++) {
    tableStrategyMap.put("Keyspace" + i,getStrategy("Keyspace" + i,tmd));
  }
  Multimap<InetAddress,Range> keyspace1ranges=tableStrategyMap.get("Keyspace1").getAddressRanges();
  Collection<Range> ranges1=keyspace1ranges.get(InetAddress.getByName("127.0.0.1"));
  assertEquals(collectionSize(ranges1),1);
  assertTrue(ranges1.iterator().next().equals(generateRange(92,0)));
  Collection<Range> ranges2=keyspace1ranges.get(InetAddress.getByName("127.0.0.2"));
  assertEquals(collectionSize(ranges2),1);
  assertTrue(ranges2.iterator().next().equals(generateRange(0,10)));
  Collection<Range> ranges3=keyspace1ranges.get(InetAddress.getByName("127.0.0.3"));
  assertEquals(collectionSize(ranges3),1);
  assertTrue(ranges3.iterator().next().equals(generateRange(10,20)));
  Collection<Range> ranges4=keyspace1ranges.get(InetAddress.getByName("127.0.0.4"));
  assertEquals(collectionSize(ranges4),1);
  assertTrue(ranges4.iterator().next().equals(generateRange(20,30)));
  Collection<Range> ranges5=keyspace1ranges.get(InetAddress.getByName("127.0.0.5"));
  assertEquals(collectionSize(ranges5),1);
  assertTrue(ranges5.iterator().next().equals(generateRange(30,40)));
  Collection<Range> ranges6=keyspace1ranges.get(InetAddress.getByName("127.0.0.6"));
  assertEquals(collectionSize(ranges6),1);
  assertTrue(ranges6.iterator().next().equals(generateRange(40,50)));
  Collection<Range> ranges7=keyspace1ranges.get(InetAddress.getByName("127.0.0.7"));
  assertEquals(collectionSize(ranges7),1);
  assertTrue(ranges7.iterator().next().equals(generateRange(50,62)));
  Collection<Range> ranges8=keyspace1ranges.get(InetAddress.getByName("127.0.0.8"));
  assertEquals(collectionSize(ranges8),1);
  assertTrue(ranges8.iterator().next().equals(generateRange(62,70)));
  Collection<Range> ranges9=keyspace1ranges.get(InetAddress.getByName("127.0.0.9"));
  assertEquals(collectionSize(ranges9),1);
  assertTrue(ranges9.iterator().next().equals(generateRange(70,82)));
  Collection<Range> ranges10=keyspace1ranges.get(InetAddress.getByName("127.0.0.10"));
  assertEquals(collectionSize(ranges10),1);
  assertTrue(ranges10.iterator().next().equals(generateRange(82,92)));
  Multimap<InetAddress,Range> keyspace3ranges=tableStrategyMap.get("Keyspace3").getAddressRanges();
  ranges1=keyspace3ranges.get(InetAddress.getByName("127.0.0.1"));
  assertEquals(collectionSize(ranges1),5);
  assertTrue(ranges1.equals(generateRanges(92,0,70,82,50,62,82,92,62,70)));
  ranges2=keyspace3ranges.get(InetAddress.getByName("127.0.0.2"));
  assertEquals(collectionSize(ranges2),5);
  assertTrue(ranges2.equals(generateRanges(92,0,70,82,82,92,0,10,62,70)));
  ranges3=keyspace3ranges.get(InetAddress.getByName("127.0.0.3"));
  assertEquals(collectionSize(ranges3),5);
  assertTrue(ranges3.equals(generateRanges(92,0,70,82,82,92,0,10,10,20)));
  ranges4=keyspace3ranges.get(InetAddress.getByName("127.0.0.4"));
  assertEquals(collectionSize(ranges4),5);
  assertTrue(ranges4.equals(generateRanges(92,0,20,30,82,92,0,10,10,20)));
  ranges5=keyspace3ranges.get(InetAddress.getByName("127.0.0.5"));
  assertEquals(collectionSize(ranges5),5);
  assertTrue(ranges5.equals(generateRanges(92,0,30,40,20,30,0,10,10,20)));
  ranges6=keyspace3ranges.get(InetAddress.getByName("127.0.0.6"));
  assertEquals(collectionSize(ranges6),5);
  assertTrue(ranges6.equals(generateRanges(40,50,30,40,20,30,0,10,10,20)));
  ranges7=keyspace3ranges.get(InetAddress.getByName("127.0.0.7"));
  assertEquals(collectionSize(ranges7),5);
  assertTrue(ranges7.equals(generateRanges(40,50,30,40,50,62,20,30,10,20)));
  ranges8=keyspace3ranges.get(InetAddress.getByName("127.0.0.8"));
  assertEquals(collectionSize(ranges8),5);
  assertTrue(ranges8.equals(generateRanges(40,50,30,40,50,62,20,30,62,70)));
  ranges9=keyspace3ranges.get(InetAddress.getByName("127.0.0.9"));
  assertEquals(collectionSize(ranges9),5);
  assertTrue(ranges9.equals(generateRanges(40,50,70,82,30,40,50,62,62,70)));
  ranges10=keyspace3ranges.get(InetAddress.getByName("127.0.0.10"));
  assertEquals(collectionSize(ranges10),5);
  assertTrue(ranges10.equals(generateRanges(40,50,70,82,50,62,82,92,62,70)));
  Multimap<InetAddress,Range> keyspace4ranges=tableStrategyMap.get("Keyspace4").getAddressRanges();
  ranges1=keyspace4ranges.get(InetAddress.getByName("127.0.0.1"));
  assertEquals(collectionSize(ranges1),3);
  assertTrue(ranges1.equals(generateRanges(92,0,70,82,82,92)));
  ranges2=keyspace4ranges.get(InetAddress.getByName("127.0.0.2"));
  assertEquals(collectionSize(ranges2),3);
  assertTrue(ranges2.equals(generateRanges(92,0,82,92,0,10)));
  ranges3=keyspace4ranges.get(InetAddress.getByName("127.0.0.3"));
  assertEquals(collectionSize(ranges3),3);
  assertTrue(ranges3.equals(generateRanges(92,0,0,10,10,20)));
  ranges4=keyspace4ranges.get(InetAddress.getByName("127.0.0.4"));
  assertEquals(collectionSize(ranges4),3);
  assertTrue(ranges4.equals(generateRanges(20,30,0,10,10,20)));
  ranges5=keyspace4ranges.get(InetAddress.getByName("127.0.0.5"));
  assertEquals(collectionSize(ranges5),3);
  assertTrue(ranges5.equals(generateRanges(30,40,20,30,10,20)));
  ranges6=keyspace4ranges.get(InetAddress.getByName("127.0.0.6"));
  assertEquals(collectionSize(ranges6),3);
  assertTrue(ranges6.equals(generateRanges(40,50,30,40,20,30)));
  ranges7=keyspace4ranges.get(InetAddress.getByName("127.0.0.7"));
  assertEquals(collectionSize(ranges7),3);
  assertTrue(ranges7.equals(generateRanges(40,50,30,40,50,62)));
  ranges8=keyspace4ranges.get(InetAddress.getByName("127.0.0.8"));
  assertEquals(collectionSize(ranges8),3);
  assertTrue(ranges8.equals(generateRanges(40,50,50,62,62,70)));
  ranges9=keyspace4ranges.get(InetAddress.getByName("127.0.0.9"));
  assertEquals(collectionSize(ranges9),3);
  assertTrue(ranges9.equals(generateRanges(70,82,50,62,62,70)));
  ranges10=keyspace4ranges.get(InetAddress.getByName("127.0.0.10"));
  assertEquals(collectionSize(ranges10),3);
  assertTrue(ranges10.equals(generateRanges(70,82,82,92,62,70)));
  Map<String,Multimap<Token,InetAddress>> expectedEndpoints=new HashMap<String,Multimap<Token,InetAddress>>();
  expectedEndpoints.put("Keyspace1",HashMultimap.<Token,InetAddress>create());
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("5"),makeAddrs("127.0.0.2"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("15"),makeAddrs("127.0.0.3"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("25"),makeAddrs("127.0.0.4"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("35"),makeAddrs("127.0.0.5"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("45"),makeAddrs("127.0.0.6"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("55"),makeAddrs("127.0.0.7","127.0.1.1"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("65"),makeAddrs("127.0.0.8"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("75"),makeAddrs("127.0.0.9","127.0.1.2"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("85"),makeAddrs("127.0.0.10"));
  expectedEndpoints.get("Keyspace1").putAll(new BigIntegerToken("95"),makeAddrs("127.0.0.1"));
  expectedEndpoints.put("Keyspace2",HashMultimap.<Token,InetAddress>create());
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("5"),makeAddrs("127.0.0.2"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("15"),makeAddrs("127.0.0.3"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("25"),makeAddrs("127.0.0.4"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("35"),makeAddrs("127.0.0.5"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("45"),makeAddrs("127.0.0.6"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("55"),makeAddrs("127.0.0.7","127.0.1.1"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("65"),makeAddrs("127.0.0.8"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("75"),makeAddrs("127.0.0.9","127.0.1.2"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("85"),makeAddrs("127.0.0.10"));
  expectedEndpoints.get("Keyspace2").putAll(new BigIntegerToken("95"),makeAddrs("127.0.0.1"));
  expectedEndpoints.put("Keyspace3",HashMultimap.<Token,InetAddress>create());
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("5"),makeAddrs("127.0.0.2","127.0.0.3","127.0.0.4","127.0.0.5","127.0.0.6"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("15"),makeAddrs("127.0.0.3","127.0.0.4","127.0.0.5","127.0.0.6","127.0.0.7","127.0.1.1"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("25"),makeAddrs("127.0.0.4","127.0.0.5","127.0.0.6","127.0.0.7","127.0.0.8","127.0.1.1"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("35"),makeAddrs("127.0.0.5","127.0.0.6","127.0.0.7","127.0.0.8","127.0.0.9","127.0.1.1","127.0.1.2"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("45"),makeAddrs("127.0.0.6","127.0.0.7","127.0.0.8","127.0.0.9","127.0.0.10","127.0.1.1","127.0.1.2"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("55"),makeAddrs("127.0.0.7","127.0.0.8","127.0.0.9","127.0.0.10","127.0.0.1","127.0.1.1","127.0.1.2"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("65"),makeAddrs("127.0.0.8","127.0.0.9","127.0.0.10","127.0.0.1","127.0.0.2","127.0.1.2"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("75"),makeAddrs("127.0.0.9","127.0.0.10","127.0.0.1","127.0.0.2","127.0.0.3","127.0.1.2"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("85"),makeAddrs("127.0.0.10","127.0.0.1","127.0.0.2","127.0.0.3","127.0.0.4"));
  expectedEndpoints.get("Keyspace3").putAll(new BigIntegerToken("95"),makeAddrs("127.0.0.1","127.0.0.2","127.0.0.3","127.0.0.4","127.0.0.5"));
  expectedEndpoints.put("Keyspace4",HashMultimap.<Token,InetAddress>create());
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("5"),makeAddrs("127.0.0.2","127.0.0.3","127.0.0.4"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("15"),makeAddrs("127.0.0.3","127.0.0.4","127.0.0.5"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("25"),makeAddrs("127.0.0.4","127.0.0.5","127.0.0.6"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("35"),makeAddrs("127.0.0.5","127.0.0.6","127.0.0.7","127.0.1.1"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("45"),makeAddrs("127.0.0.6","127.0.0.7","127.0.0.8","127.0.1.1"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("55"),makeAddrs("127.0.0.7","127.0.0.8","127.0.0.9","127.0.1.1","127.0.1.2"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("65"),makeAddrs("127.0.0.8","127.0.0.9","127.0.0.10","127.0.1.2"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("75"),makeAddrs("127.0.0.9","127.0.0.10","127.0.0.1","127.0.1.2"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("85"),makeAddrs("127.0.0.10","127.0.0.1","127.0.0.2"));
  expectedEndpoints.get("Keyspace4").putAll(new BigIntegerToken("95"),makeAddrs("127.0.0.1","127.0.0.2","127.0.0.3"));
  for (  Map.Entry<String,AbstractReplicationStrategy> tableStrategy : tableStrategyMap.entrySet()) {
    String table=tableStrategy.getKey();
    AbstractReplicationStrategy strategy=tableStrategy.getValue();
    for (    Token token : keyTokens) {
      endpoints=tmd.getWriteEndpoints(token,table,strategy.getNaturalEndpoints(token)).left;
      assertTrue(expectedEndpoints.get(table).get(token).size() == endpoints.size());
      assertTrue(expectedEndpoints.get(table).get(token).containsAll(endpoints));
    }
    if (strategy.getReplicationFactor() != 3)     continue;
    for (int i=0; i < 3; i++) {
      endpoints=tmd.getWriteEndpoints(keyTokens.get(i),table,strategy.getNaturalEndpoints(keyTokens.get(i))).left;
      assertTrue(endpoints.size() == 3);
      assertTrue(endpoints.contains(hosts.get(i + 1)));
      assertTrue(endpoints.contains(hosts.get(i + 2)));
      assertTrue(endpoints.contains(hosts.get(i + 3)));
    }
    endpoints=tmd.getWriteEndpoints(keyTokens.get(3),table,strategy.getNaturalEndpoints(keyTokens.get(3))).left;
    assertTrue(endpoints.size() == 4);
    assertTrue(endpoints.contains(hosts.get(4)));
    assertTrue(endpoints.contains(hosts.get(5)));
    assertTrue(endpoints.contains(hosts.get(6)));
    assertTrue(endpoints.contains(boot1));
    endpoints=tmd.getWriteEndpoints(keyTokens.get(4),table,strategy.getNaturalEndpoints(keyTokens.get(4))).left;
    assertTrue(endpoints.size() == 4);
    assertTrue(endpoints.contains(hosts.get(5)));
    assertTrue(endpoints.contains(hosts.get(6)));
    assertTrue(endpoints.contains(hosts.get(7)));
    assertTrue(endpoints.contains(boot1));
    endpoints=tmd.getWriteEndpoints(keyTokens.get(5),table,strategy.getNaturalEndpoints(keyTokens.get(5))).left;
    assertTrue(endpoints.size() == 5);
    assertTrue(endpoints.contains(hosts.get(6)));
    assertTrue(endpoints.contains(hosts.get(7)));
    assertTrue(endpoints.contains(hosts.get(8)));
    assertTrue(endpoints.contains(boot1));
    assertTrue(endpoints.contains(boot2));
    endpoints=tmd.getWriteEndpoints(keyTokens.get(6),table,strategy.getNaturalEndpoints(keyTokens.get(6))).left;
    assertTrue(endpoints.size() == 4);
    assertTrue(endpoints.contains(hosts.get(7)));
    assertTrue(endpoints.contains(hosts.get(8)));
    assertTrue(endpoints.contains(hosts.get(9)));
    assertTrue(endpoints.contains(boot2));
    endpoints=tmd.getWriteEndpoints(keyTokens.get(7),table,strategy.getNaturalEndpoints(keyTokens.get(7))).left;
    assertTrue(endpoints.size() == 4);
    assertTrue(endpoints.contains(hosts.get(8)));
    assertTrue(endpoints.contains(hosts.get(9)));
    assertTrue(endpoints.contains(hosts.get(0)));
    assertTrue(endpoints.contains(boot2));
    endpoints=tmd.getWriteEndpoints(keyTokens.get(8),table,strategy.getNaturalEndpoints(keyTokens.get(8))).left;
    assertTrue(endpoints.size() == 3);
    assertTrue(endpoints.contains(hosts.get(9)));
    assertTrue(endpoints.contains(hosts.get(0)));
    assertTrue(endpoints.contains(hosts.get(1)));
    endpoints=tmd.getWriteEndpoints(keyTokens.get(9),table,strategy.getNaturalEndpoints(keyTokens.get(9))).left;
    assertTrue(endpoints.size() == 3);
    assertTrue(endpoints.contains(hosts.get(0)));
    assertTrue(endpoints.contains(hosts.get(1)));
    assertTrue(endpoints.contains(hosts.get(2)));
  }
  for (  Integer movingIndex : MOVING) {
    ss.onChange(hosts.get(movingIndex),ApplicationState.STATUS,valueFactory.normal(newTokens.get(movingIndex)));
  }
  ss.setPartitionerUnsafe(oldPartitioner);
}
