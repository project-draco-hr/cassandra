{
  boolean transformed=false;
  Collection<Cell> insert;
  if (cm instanceof UnsortedColumns) {
    insert=transform(metadata.comparator.columnComparator(),cm,transformation,true);
    transformed=true;
  }
 else   insert=cm.getSortedColumns();
  while (true) {
    Holder current=ref;
    DeletionInfo deletionInfo=cm.deletionInfo();
    if (deletionInfo.hasRanges()) {
      for (      Iterator<Cell> iter : new Iterator[]{insert.iterator(),BTree.<Cell>slice(current.tree,true)}) {
        while (iter.hasNext()) {
          Cell col=iter.next();
          if (deletionInfo.isDeleted(col))           indexer.remove(col);
        }
      }
    }
    deletionInfo=current.deletionInfo.copy().add(deletionInfo);
    ColumnUpdater updater=new ColumnUpdater(allocator,transformation,indexer);
    Holder h=current.update(this,deletionInfo,metadata.comparator.columnComparator(),insert,updater);
    if (h != null && refUpdater.compareAndSet(this,current,h)) {
      indexer.updateRowLevelIndexes();
      return updater.delta;
    }
    if (!transformed) {
      insert=transform(metadata.comparator.columnComparator(),cm,transformation,false);
      transformed=true;
    }
  }
}
