{
  if (!StorageService.instance.isInitialized())   return;
  if (!registered) {
    if (MessagingService.instance() != null) {
      MessagingService.instance().register(this);
      registered=true;
    }
  }
  double maxLatency=1;
  long maxPenalty=1;
  HashMap<InetAddress,Long> penalties=new HashMap<InetAddress,Long>(samples.size());
  for (  Map.Entry<InetAddress,ExponentiallyDecayingReservoir> entry : samples.entrySet()) {
    double mean=entry.getValue().getSnapshot().getMedian();
    if (mean > maxLatency)     maxLatency=mean;
    long timePenalty=lastReceived.containsKey(entry.getKey()) ? lastReceived.get(entry.getKey()) : System.nanoTime();
    timePenalty=TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - timePenalty);
    timePenalty=timePenalty > UPDATE_INTERVAL_IN_MS ? UPDATE_INTERVAL_IN_MS : timePenalty;
    penalties.put(entry.getKey(),timePenalty);
    if (timePenalty > maxPenalty)     maxPenalty=timePenalty;
  }
  for (  Map.Entry<InetAddress,ExponentiallyDecayingReservoir> entry : samples.entrySet()) {
    double score=entry.getValue().getSnapshot().getMedian() / maxLatency;
    if (penalties.containsKey(entry.getKey()))     score+=penalties.get(entry.getKey()) / ((double)maxPenalty);
 else     score+=1;
    score+=StorageService.instance.getSeverity(entry.getKey());
    scores.put(entry.getKey(),score);
  }
}
