{
  Token searchToken=searchPosition.getToken();
  Token keyToken=TokenMetadata.firstToken(tokenMetadata.sortedTokens(),searchToken);
  ArrayList<InetAddress> endpoints=getCachedEndpoints(keyToken);
  if (endpoints == null) {
    if (tokenMetadataClone == null) {
synchronized (this) {
        if (tokenMetadataClone == null)         tokenMetadataClone=tokenMetadata.cloneOnlyTokenMap();
      }
      keyToken=TokenMetadata.firstToken(tokenMetadataClone.sortedTokens(),searchToken);
    }
    endpoints=new ArrayList<InetAddress>(calculateNaturalEndpoints(searchToken,tokenMetadataClone));
    cachedEndpoints.put(keyToken,endpoints);
  }
  return new ArrayList<InetAddress>(endpoints);
}
