{
  Multimap<InetAddress,InetAddress> map=HashMultimap.create(targets.size(),1);
  IEndpointSnitch endpointSnitch=DatabaseDescriptor.getEndpointSnitch();
  for (  InetAddress ep : targets) {
    if (FailureDetector.instance.isAlive(ep))     map.put(ep,ep);
  }
  if (map.size() == targets.size() || !StorageProxy.isHintedHandoffEnabled())   return map;
  InetAddress localAddress=FBUtilities.getLocalAddress();
  for (  InetAddress ep : targets) {
    if (map.containsKey(ep))     continue;
    InetAddress destination=map.isEmpty() ? localAddress : endpointSnitch.getSortedListByProximity(localAddress,map.keySet()).get(0);
    map.put(destination,ep);
  }
  return map;
}
