{
  Keyspace keyspace=Keyspace.open(KEYSPACE);
  ColumnFamilyStore cfs=keyspace.getColumnFamilyStore(CF);
  truncate(cfs);
  cfs.disableAutoCompaction();
  SSTableReader s=writeFile(cfs,400);
  cfs.addSSTable(s);
  Set<SSTableReader> compacting=Sets.newHashSet(s);
  SSTableRewriter.overrideOpenInterval(1000000);
  List<SSTableReader> sstables;
  int files=1;
  try (ISSTableScanner scanner=s.getScanner();CompactionController controller=new CompactionController(cfs,compacting,0);LifecycleTransaction txn=cfs.getTracker().tryModify(compacting,OperationType.UNKNOWN);SSTableRewriter rewriter=new SSTableRewriter(cfs,txn,1000,false)){
    rewriter.switchWriter(getWriter(cfs,s.descriptor.directory));
    while (scanner.hasNext()) {
      rewriter.append(new LazilyCompactedRow(controller,Arrays.asList(scanner.next())));
      if (rewriter.currentWriter().getOnDiskFilePointer() > 2500000) {
        assertEquals(files,cfs.getSSTables().size());
        rewriter.switchWriter(getWriter(cfs,s.descriptor.directory));
        files++;
      }
    }
    sstables=rewriter.finish();
  }
   assertEquals(files,sstables.size());
  assertEquals(files,cfs.getSSTables().size());
  SSTableDeletingTask.waitForDeletions();
  assertFileCounts(s.descriptor.directory.list(),0,0);
  validateCFS(cfs);
}
