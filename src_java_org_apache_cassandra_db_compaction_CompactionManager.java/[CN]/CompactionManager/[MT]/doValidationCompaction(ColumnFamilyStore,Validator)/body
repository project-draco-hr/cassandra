{
  if (!cfs.isValid())   return;
  Collection<SSTableReader> sstables;
  String snapshotName=validator.desc.sessionId.toString();
  int gcBefore;
  boolean isSnapshotValidation=cfs.snapshotExists(snapshotName);
  if (isSnapshotValidation) {
    sstables=cfs.getSnapshotSSTableReader(snapshotName);
    gcBefore=cfs.gcBefore(cfs.getSnapshotCreationTime(snapshotName));
  }
 else {
    StorageService.instance.forceKeyspaceFlush(cfs.keyspace.getName(),cfs.name);
    if (validator.desc.parentSessionId == null || ActiveRepairService.instance.getParentRepairSession(validator.desc.parentSessionId) == null)     sstables=cfs.markCurrentSSTablesReferenced();
 else     sstables=ActiveRepairService.instance.getParentRepairSession(validator.desc.parentSessionId).getAndReferenceSSTables(cfs.metadata.cfId);
    if (validator.gcBefore > 0)     gcBefore=validator.gcBefore;
 else     gcBefore=getDefaultGcBefore(cfs);
  }
  CompactionIterable ci=new ValidationCompactionIterable(cfs,sstables,validator.desc.range,gcBefore);
  CloseableIterator<AbstractCompactedRow> iter=ci.iterator();
  metrics.beginCompaction(ci);
  try {
    validator.prepare(cfs);
    while (iter.hasNext()) {
      if (ci.isStopRequested())       throw new CompactionInterruptedException(ci.getCompactionInfo());
      AbstractCompactedRow row=iter.next();
      validator.add(row);
    }
    validator.complete();
  }
  finally {
    iter.close();
    SSTableReader.releaseReferences(sstables);
    if (isSnapshotValidation) {
      cfs.clearSnapshot(snapshotName);
    }
    metrics.finishCompaction(ci);
  }
}
