{
  Runnable runnable=new Runnable(){
    public void run(){
      compactionLock.readLock().lock();
      try {
        metrics.beginCompaction(builder);
        try {
          builder.build();
        }
  finally {
          metrics.finishCompaction(builder);
        }
      }
  finally {
        compactionLock.readLock().unlock();
      }
    }
  }
;
  if (compactionLock.isWriteLockedByCurrentThread())   return new SimpleFuture(runnable);
 else   return executor.submit(runnable);
}
