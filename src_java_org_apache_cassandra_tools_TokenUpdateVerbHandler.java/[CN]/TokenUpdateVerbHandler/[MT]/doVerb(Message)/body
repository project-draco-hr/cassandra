{
  byte[] body=message.getMessageBody();
  try {
    DataInputBuffer bufIn=new DataInputBuffer();
    bufIn.reset(body,body.length);
    Token token=Token.serializer().deserialize(bufIn);
    logger_.info("Updating the token to [" + token + "]");
    StorageService.instance().updateToken(token);
    Map<String,byte[]> headers=message.getHeaders();
    headers.remove(StorageService.getLocalStorageEndPoint().getHost());
    if (logger_.isDebugEnabled())     logger_.debug("Number of nodes in the header " + headers.size());
    Set<String> nodes=headers.keySet();
    IPartitioner p=StorageService.getPartitioner();
    for (    String node : nodes) {
      if (logger_.isDebugEnabled())       logger_.debug("Processing node " + node);
      byte[] bytes=headers.remove(node);
      EndPoint target=new EndPoint(node,DatabaseDescriptor.getStoragePort());
      token=p.getTokenFactory().fromByteArray(bytes);
      ByteArrayOutputStream bos=new ByteArrayOutputStream();
      DataOutputStream dos=new DataOutputStream(bos);
      Token.serializer().serialize(token,dos);
      message.setMessageBody(bos.toByteArray());
      if (logger_.isDebugEnabled())       logger_.debug("Sending a token update message to " + target + " to update it to "+ token);
      MessagingService.getMessagingInstance().sendOneWay(message,target);
      break;
    }
  }
 catch (  IOException ex) {
    if (logger_.isDebugEnabled())     logger_.debug(LogUtil.throwableToString(ex));
  }
}
