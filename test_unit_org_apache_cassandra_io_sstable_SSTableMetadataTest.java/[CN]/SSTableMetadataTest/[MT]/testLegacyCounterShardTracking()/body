{
  ColumnFamilyStore cfs=Keyspace.open("Keyspace1").getColumnFamilyStore("Counter1");
  CounterContext.ContextState state=CounterContext.ContextState.allocate(1,1,1);
  state.writeGlobal(CounterId.fromInt(1),1L,1L);
  state.writeLocal(CounterId.fromInt(2),1L,1L);
  state.writeRemote(CounterId.fromInt(3),1L,1L);
  ColumnFamily cells=ArrayBackedSortedColumns.factory.create(cfs.metadata);
  cells.addColumn(new BufferCounterCell(cellname("col"),state.context,1L,Long.MIN_VALUE));
  new Mutation(Util.dk("k").getKey(),cells).apply();
  cfs.forceBlockingFlush();
  assertTrue(cfs.getSSTables().iterator().next().getSSTableMetadata().hasLegacyCounterShards);
  cfs.truncateBlocking();
  state=CounterContext.ContextState.allocate(0,1,1);
  state.writeLocal(CounterId.fromInt(2),1L,1L);
  state.writeRemote(CounterId.fromInt(3),1L,1L);
  cells=ArrayBackedSortedColumns.factory.create(cfs.metadata);
  cells.addColumn(new BufferCounterCell(cellname("col"),state.context,1L,Long.MIN_VALUE));
  new Mutation(Util.dk("k").getKey(),cells).apply();
  cfs.forceBlockingFlush();
  assertTrue(cfs.getSSTables().iterator().next().getSSTableMetadata().hasLegacyCounterShards);
  cfs.truncateBlocking();
  state=CounterContext.ContextState.allocate(1,1,0);
  state.writeGlobal(CounterId.fromInt(1),1L,1L);
  state.writeLocal(CounterId.fromInt(2),1L,1L);
  cells=ArrayBackedSortedColumns.factory.create(cfs.metadata);
  cells.addColumn(new BufferCounterCell(cellname("col"),state.context,1L,Long.MIN_VALUE));
  new Mutation(Util.dk("k").getKey(),cells).apply();
  cfs.forceBlockingFlush();
  assertTrue(cfs.getSSTables().iterator().next().getSSTableMetadata().hasLegacyCounterShards);
  cfs.truncateBlocking();
  state=CounterContext.ContextState.allocate(1,0,0);
  state.writeGlobal(CounterId.fromInt(1),1L,1L);
  cells=ArrayBackedSortedColumns.factory.create(cfs.metadata);
  cells.addColumn(new BufferCounterCell(cellname("col"),state.context,1L,Long.MIN_VALUE));
  new Mutation(Util.dk("k").getKey(),cells).apply();
  cfs.forceBlockingFlush();
  assertFalse(cfs.getSSTables().iterator().next().getSSTableMetadata().hasLegacyCounterShards);
  cfs.truncateBlocking();
}
