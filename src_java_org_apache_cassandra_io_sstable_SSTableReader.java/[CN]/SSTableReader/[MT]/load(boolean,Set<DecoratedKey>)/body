{
  boolean cacheLoading=keyCache != null && !keysToLoadInCache.isEmpty();
  SegmentedFile.Builder ibuilder=SegmentedFile.getBuilder(DatabaseDescriptor.getIndexAccessMode());
  SegmentedFile.Builder dbuilder=(components.contains(Component.COMPRESSION_INFO)) ? SegmentedFile.getCompressedBuilder() : SegmentedFile.getBuilder(DatabaseDescriptor.getDiskAccessMode());
  RandomAccessReader input=RandomAccessReader.open(new File(descriptor.filenameFor(Component.PRIMARY_INDEX)),true);
  DecoratedKey left=null, right=null;
  try {
    if (keyCache != null && keyCache.getCapacity() - keyCache.size() < keysToLoadInCache.size())     keyCache.updateCapacity(keyCache.size() + keysToLoadInCache.size());
    long indexSize=input.length();
    long estimatedKeys=SSTable.estimateRowsFromIndex(input);
    indexSummary=new IndexSummary(estimatedKeys);
    if (recreatebloom)     bf=LegacyBloomFilter.getFilter(estimatedKeys,15);
    while (true) {
      long indexPosition=input.getFilePointer();
      if (indexPosition == indexSize)       break;
      ByteBuffer key=null, skippedKey;
      skippedKey=ByteBufferUtil.readWithShortLength(input);
      boolean shouldAddEntry=indexSummary.shouldAddEntry();
      if (shouldAddEntry || cacheLoading || recreatebloom) {
        key=skippedKey;
      }
      if (null == left)       left=decodeKey(partitioner,descriptor,skippedKey);
      right=decodeKey(partitioner,descriptor,skippedKey);
      long dataPosition=input.readLong();
      if (key != null) {
        DecoratedKey decoratedKey=decodeKey(partitioner,descriptor,key);
        if (recreatebloom)         bf.add(decoratedKey.key);
        if (shouldAddEntry)         indexSummary.addEntry(decoratedKey,indexPosition);
        if (cacheLoading && keysToLoadInCache.contains(decoratedKey))         cacheKey(decoratedKey,dataPosition);
      }
      indexSummary.incrementRowid();
      ibuilder.addPotentialBoundary(indexPosition);
      dbuilder.addPotentialBoundary(dataPosition);
    }
    indexSummary.complete();
  }
  finally {
    FileUtils.closeQuietly(input);
  }
  this.first=left;
  this.last=right;
  ifile=ibuilder.complete(descriptor.filenameFor(Component.PRIMARY_INDEX));
  dfile=dbuilder.complete(descriptor.filenameFor(Component.DATA));
}
