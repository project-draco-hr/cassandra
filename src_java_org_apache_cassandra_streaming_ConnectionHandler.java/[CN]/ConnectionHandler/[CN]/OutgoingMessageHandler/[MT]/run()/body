{
  StreamMessage next;
  while (!isClosed()) {
    try {
      if ((next=messageQueue.poll(1,TimeUnit.SECONDS)) != null) {
        logger.debug("[Stream #{}] Sending {}",session.planId(),next);
        sendMessage(next);
        if (next.type == StreamMessage.Type.SESSION_FAILED)         close();
      }
    }
 catch (    InterruptedException e) {
      throw new AssertionError(e);
    }
  }
  try {
    while ((next=messageQueue.poll()) != null)     sendMessage(next);
  }
  finally {
    signalCloseDone();
  }
}
