{
  while (!isClosed()) {
    try {
      StreamMessage message=StreamMessage.deserialize(in,protocolVersion,session);
      if (message != null) {
        logger.debug("[Stream #{}] Received {}",session.planId(),message);
        session.messageReceived(message);
      }
    }
 catch (    SocketException e) {
      close();
    }
catch (    Throwable e) {
      session.onError(e);
    }
  }
  signalCloseDone();
}
