{
  CFDefinition cfDef=cfm.getCfDef();
  ColumnNameBuilder keyBuilder=cfDef.getKeyNameBuilder();
  List<ByteBuffer> keys=new ArrayList<ByteBuffer>();
  for (  CFDefinition.Name name : cfDef.partitionKeys()) {
    Restriction r=processedKeys.get(name.name);
    if (r == null)     throw new InvalidRequestException(String.format("Missing mandatory PRIMARY KEY part %s",name));
    List<ByteBuffer> values=r.values(variables);
    if (keyBuilder.remainingCount() == 1) {
      for (      ByteBuffer val : values) {
        if (val == null)         throw new InvalidRequestException(String.format("Invalid null value for partition key part %s",name));
        ByteBuffer key=keyBuilder.copy().add(val).build();
        ThriftValidation.validateKey(cfm,key);
        keys.add(key);
      }
    }
 else {
      if (values.size() != 1)       throw new InvalidRequestException("IN is only supported on the last column of the partition key");
      ByteBuffer val=values.get(0);
      if (val == null)       throw new InvalidRequestException(String.format("Invalid null value for partition key part %s",name));
      keyBuilder.add(val);
    }
  }
  return keys;
}
