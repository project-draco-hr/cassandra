{
  Gossiper gossiper=Gossiper.instance;
  int waited=0;
  while (gossiper.getEndpointStateForEndpoint(endpoint) != null && gossiper.getEndpointStateForEndpoint(endpoint).getApplicationState(ApplicationState.SCHEMA) == null) {
    Uninterruptibles.sleepUninterruptibly(1,TimeUnit.SECONDS);
    waited+=1000;
    if (waited > 2 * StorageService.RING_DELAY)     throw new TimeoutException("Didin't receive gossiped schema from " + endpoint + " in "+ 2 * StorageService.RING_DELAY + "ms");
  }
  if (gossiper.getEndpointStateForEndpoint(endpoint) == null)   throw new TimeoutException("Node " + endpoint + " vanished while waiting for agreement");
  waited=0;
  while (gossiper.getEndpointStateForEndpoint(endpoint) != null && !gossiper.getEndpointStateForEndpoint(endpoint).getApplicationState(ApplicationState.SCHEMA).value.equals(gossiper.getEndpointStateForEndpoint(FBUtilities.getBroadcastAddress()).getApplicationState(ApplicationState.SCHEMA).value)) {
    Uninterruptibles.sleepUninterruptibly(1,TimeUnit.SECONDS);
    waited+=1000;
    if (waited > 2 * StorageService.RING_DELAY)     throw new TimeoutException("Could not reach schema agreement with " + endpoint + " in "+ 2 * StorageService.RING_DELAY + "ms");
  }
  if (gossiper.getEndpointStateForEndpoint(endpoint) == null)   throw new TimeoutException("Node " + endpoint + " vanished while waiting for agreement");
  logger.trace("schema for {} matches local schema",endpoint);
  return waited;
}
