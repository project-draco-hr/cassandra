{
  logger_.info("Started hinted handoff for endpoint " + endpoint);
  queuedDeliveries.remove(endpoint);
  ByteBuffer endpointAsUTF8=ByteBuffer.wrap(endpoint.getHostAddress().getBytes(UTF_8));
  DecoratedKey epkey=StorageService.getPartitioner().decorateKey(endpointAsUTF8);
  int rowsReplayed=0;
  ColumnFamilyStore hintStore=Table.open(Table.SYSTEM_TABLE).getColumnFamilyStore(HINTS_CF);
  ByteBuffer startColumn=ByteBufferUtil.EMPTY_BYTE_BUFFER;
  delivery:   while (true) {
    QueryFilter filter=QueryFilter.getSliceFilter(epkey,new QueryPath(HINTS_CF),startColumn,ByteBufferUtil.EMPTY_BYTE_BUFFER,false,PAGE_SIZE);
    ColumnFamily hintColumnFamily=ColumnFamilyStore.removeDeleted(hintStore.getColumnFamily(filter),Integer.MAX_VALUE);
    if (pagingFinished(hintColumnFamily,startColumn))     break;
    for (    IColumn keyColumn : hintColumnFamily.getSortedColumns()) {
      startColumn=keyColumn.name();
      Collection<IColumn> tableCFs=keyColumn.getSubColumns();
      for (      IColumn tableCF : tableCFs) {
        String[] parts=getTableAndCFNames(tableCF.name());
        if (sendMessage(endpoint,parts[0],parts[1],keyColumn.name())) {
          deleteHintKey(endpointAsUTF8,keyColumn.name(),tableCF.name(),tableCF.timestamp());
          rowsReplayed++;
        }
 else {
          logger_.info("Could not complete hinted handoff to " + endpoint);
          break delivery;
        }
        startColumn=keyColumn.name();
      }
    }
  }
  if (rowsReplayed > 0) {
    hintStore.forceFlush();
    try {
      CompactionManager.instance.submitMajor(hintStore,0,Integer.MAX_VALUE).get();
    }
 catch (    Exception e) {
      throw new RuntimeException(e);
    }
  }
  logger_.info(String.format("Finished hinted handoff of %s rows to endpoint %s",rowsReplayed,endpoint));
}
