{
  try {
    serverTransport_.listen();
  }
 catch (  TTransportException ttx) {
    LOGGER.error("Error occurred during listening.",ttx);
    return;
  }
  stopped_=false;
  while (!stopped_) {
    while (activeClients.get() >= options_.maxWorkerThreads) {
      try {
        Thread.sleep(100);
      }
 catch (      InterruptedException e) {
        throw new AssertionError(e);
      }
    }
    int failureCount=0;
    try {
      TTransport client=serverTransport_.accept();
      activeClients.incrementAndGet();
      WorkerProcess wp=new WorkerProcess(client);
      executorService_.execute(wp);
    }
 catch (    TTransportException ttx) {
      if (!stopped_) {
        ++failureCount;
        LOGGER.warn("Transport error occurred during acceptance of message.",ttx);
      }
    }
    if (activeClients.get() >= options_.maxWorkerThreads)     LOGGER.warn("Maximum number of clients " + options_.maxWorkerThreads + " reached");
  }
  executorService_.shutdown();
  long timeoutMS=options_.stopTimeoutUnit.toMillis(options_.stopTimeoutVal);
  long now=System.currentTimeMillis();
  while (timeoutMS >= 0) {
    try {
      executorService_.awaitTermination(timeoutMS,TimeUnit.MILLISECONDS);
      break;
    }
 catch (    InterruptedException ix) {
      long newnow=System.currentTimeMillis();
      timeoutMS-=(newnow - now);
      now=newnow;
    }
  }
}
