{
  MapDifference<DecoratedKey,ColumnFamily> diff=Maps.difference(old,updated);
  for (  Map.Entry<DecoratedKey,ColumnFamily> entry : diff.entriesOnlyOnRight().entrySet()) {
    ColumnFamily cfAttrs=entry.getValue();
    if (!cfAttrs.isEmpty()) {
      Map<String,CFMetaData> cfDefs=KSMetaData.deserializeColumnFamilies(new Row(entry.getKey(),cfAttrs));
      for (      CFMetaData cfDef : cfDefs.values())       MigrationHelper.addColumnFamily(cfDef,-1,false);
    }
  }
  Map<DecoratedKey,MapDifference.ValueDifference<ColumnFamily>> modifiedEntries=diff.entriesDiffering();
  for (  DecoratedKey keyspace : modifiedEntries.keySet()) {
    MapDifference.ValueDifference<ColumnFamily> valueDiff=modifiedEntries.get(keyspace);
    ColumnFamily prevValue=valueDiff.leftValue();
    ColumnFamily newValue=valueDiff.rightValue();
    Row newRow=new Row(keyspace,newValue);
    if (prevValue.isEmpty()) {
      for (      CFMetaData cfm : KSMetaData.deserializeColumnFamilies(newRow).values())       MigrationHelper.addColumnFamily(cfm,-1,false);
    }
 else     if (newValue.isEmpty()) {
      for (      CFMetaData cfm : KSMetaData.deserializeColumnFamilies(new Row(keyspace,prevValue)).values())       MigrationHelper.dropColumnFamily(cfm.ksName,cfm.cfName,-1,false);
    }
 else {
      String ksName=AsciiType.instance.getString(keyspace.key);
      Map<String,CFMetaData> oldCfDefs=new HashMap<String,CFMetaData>();
      for (      CFMetaData cfm : Schema.instance.getKSMetaData(ksName).cfMetaData().values())       oldCfDefs.put(cfm.cfName,cfm);
      Map<String,CFMetaData> newCfDefs=KSMetaData.deserializeColumnFamilies(newRow);
      MapDifference<String,CFMetaData> cfDefDiff=Maps.difference(oldCfDefs,newCfDefs);
      for (      CFMetaData cfDef : cfDefDiff.entriesOnlyOnRight().values())       MigrationHelper.addColumnFamily(cfDef,-1,false);
      for (      CFMetaData cfDef : cfDefDiff.entriesOnlyOnLeft().values())       MigrationHelper.dropColumnFamily(cfDef.ksName,cfDef.cfName,-1,false);
      for (      MapDifference.ValueDifference<CFMetaData> cfDef : cfDefDiff.entriesDiffering().values())       MigrationHelper.updateColumnFamily(cfDef.rightValue(),-1,false);
    }
  }
}
