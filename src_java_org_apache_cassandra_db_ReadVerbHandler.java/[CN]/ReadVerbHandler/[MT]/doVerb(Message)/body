{
  byte[] body=message.getMessageBody();
  ReadContext readCtx=tls_.get();
  if (readCtx == null) {
    readCtx=new ReadContext();
    tls_.set(readCtx);
  }
  readCtx.bufIn_.reset(body,body.length);
  try {
    if (StorageService.instance().isBootstrapMode()) {
      throw new RuntimeException("Cannot service reads while bootstrapping!");
    }
    ReadCommand readCommand=ReadCommand.serializer().deserialize(readCtx.bufIn_);
    Table table=Table.open(readCommand.table);
    Row row=readCommand.getRow(table);
    ReadResponse readResponse;
    if (readCommand.isDigestQuery()) {
      if (logger_.isDebugEnabled())       logger_.debug("digest is " + FBUtilities.bytesToHex(row.digest()));
      readResponse=new ReadResponse(row.digest());
    }
 else {
      readResponse=new ReadResponse(row);
    }
    readResponse.setIsDigestQuery(readCommand.isDigestQuery());
    readCtx.bufOut_.reset();
    ReadResponse.serializer().serialize(readResponse,readCtx.bufOut_);
    byte[] bytes=new byte[readCtx.bufOut_.getLength()];
    System.arraycopy(readCtx.bufOut_.getData(),0,bytes,0,bytes.length);
    Message response=message.getReply(StorageService.getLocalStorageEndPoint(),bytes);
    if (logger_.isDebugEnabled())     logger_.debug("Read key " + readCommand.key + "; sending response to "+ message.getMessageId()+ "@"+ message.getFrom());
    MessagingService.getMessagingInstance().sendOneWay(response,message.getFrom());
    if (message.getHeader(ReadCommand.DO_REPAIR) != null) {
      doReadRepair(row,readCommand);
    }
  }
 catch (  IOException ex) {
    throw new RuntimeException(ex);
  }
}
