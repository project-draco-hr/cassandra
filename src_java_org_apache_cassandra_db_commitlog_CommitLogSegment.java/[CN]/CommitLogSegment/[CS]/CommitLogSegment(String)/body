{
  id=getNextId();
  descriptor=new CommitLogDescriptor(id);
  logFile=new File(DatabaseDescriptor.getCommitLogLocation(),descriptor.fileName());
  boolean isCreating=true;
  try {
    if (filePath != null) {
      File oldFile=new File(filePath);
      if (oldFile.exists()) {
        logger.debug("Re-using discarded CommitLog segment for {} from {}",id,filePath);
        if (!oldFile.renameTo(logFile))         throw new IOException("Rename from " + filePath + " to "+ id+ " failed");
        isCreating=false;
      }
    }
    logFileAccessor=new RandomAccessFile(logFile,"rw");
    if (isCreating)     logger.debug("Creating new commit log segment {}",logFile.getPath());
    logFileAccessor.setLength(DatabaseDescriptor.getCommitLogSegmentSize());
    buffer=logFileAccessor.getChannel().map(FileChannel.MapMode.READ_WRITE,0,DatabaseDescriptor.getCommitLogSegmentSize());
    checksum=new PureJavaCrc32();
    bufferStream=new DataOutputStream(new ChecksummedOutputStream(new ByteBufferOutputStream(buffer),checksum));
    buffer.putInt(CommitLog.END_OF_SEGMENT_MARKER);
    buffer.position(0);
    needsSync=true;
    sync();
  }
 catch (  IOException e) {
    throw new FSWriteError(e,logFile);
  }
}
