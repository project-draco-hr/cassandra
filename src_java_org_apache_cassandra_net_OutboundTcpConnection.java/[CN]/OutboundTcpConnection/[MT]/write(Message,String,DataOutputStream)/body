{
  int header=0;
  header|=MessagingService.serializerType_.ordinal();
  if (false)   header|=4;
  header|=(message.getVersion() << 8);
  try {
    out.writeInt(MessagingService.PROTOCOL_MAGIC);
    out.writeInt(header);
    byte[] bytes=message.getMessageBody();
    int total=messageLength(message.header_,id,bytes);
    out.writeInt(total);
    out.writeUTF(id);
    Header.serializer().serialize(message.header_,out,message.getVersion());
    out.writeInt(bytes.length);
    out.write(bytes);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
