{
  int header=0;
  header|=MessagingService.serializerType.ordinal();
  if (false)   header|=4;
  header|=(message.getVersion() << 8);
  out.writeInt(MessagingService.PROTOCOL_MAGIC);
  out.writeInt(header);
  byte[] bytes=message.getMessageBody();
  int total=messageLength(message.header,id,bytes);
  out.writeInt(total);
  out.writeUTF(id);
  Header.serializer().serialize(message.header,out,message.getVersion());
  out.writeInt(bytes.length);
  out.write(bytes);
}
