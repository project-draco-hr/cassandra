{
  while (true) {
    QueuedMessage qm=active.poll();
    if (qm == null) {
      try {
        qm=backlog.take();
      }
 catch (      InterruptedException e) {
        throw new AssertionError(e);
      }
      BlockingQueue<QueuedMessage> tmp=backlog;
      backlog=active;
      active=tmp;
    }
    MessageOut<?> m=qm.message;
    if (m == CLOSE_SENTINEL) {
      disconnect();
      if (isStopped)       break;
      continue;
    }
    if (qm.isTimedOut(m.getTimeout()))     dropped.incrementAndGet();
 else     if (socket != null || connect())     writeConnected(qm);
 else     active.clear();
  }
}
