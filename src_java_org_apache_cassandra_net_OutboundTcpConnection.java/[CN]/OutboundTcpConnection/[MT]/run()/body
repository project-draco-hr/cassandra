{
  while (true) {
    QueuedMessage qm=active.poll();
    if (qm == null) {
      try {
        qm=backlog.take();
      }
 catch (      InterruptedException e) {
        throw new AssertionError(e);
      }
      BlockingQueue<QueuedMessage> tmp=backlog;
      backlog=active;
      active=tmp;
    }
    MessageOut<?> m=qm.message;
    String id=qm.id;
    if (m == CLOSE_SENTINEL) {
      disconnect();
      continue;
    }
    if (qm.timestamp < System.currentTimeMillis() - m.getTimeout())     dropped.incrementAndGet();
 else     if (socket != null || connect())     writeConnected(m,id);
 else     active.clear();
  }
}
