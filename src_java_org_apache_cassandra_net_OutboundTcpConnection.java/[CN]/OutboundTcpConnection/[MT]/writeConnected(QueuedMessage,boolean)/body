{
  try {
    byte[] sessionBytes=qm.message.parameters.get(Tracing.TRACE_HEADER);
    if (sessionBytes != null) {
      UUID sessionId=UUIDGen.getUUID(ByteBuffer.wrap(sessionBytes));
      TraceState state=Tracing.instance.get(sessionId);
      String message=String.format("Sending message to %s",poolReference.endPoint());
      if (state == null) {
        byte[] traceTypeBytes=qm.message.parameters.get(Tracing.TRACE_TYPE);
        Tracing.TraceType traceType=traceTypeBytes == null ? Tracing.TraceType.QUERY : Tracing.TraceType.deserialize(traceTypeBytes[0]);
        TraceState.trace(ByteBuffer.wrap(sessionBytes),message,-1,traceType.getTTL(),null);
      }
 else {
        state.trace(message);
        if (qm.message.verb == MessagingService.Verb.REQUEST_RESPONSE)         Tracing.instance.doneWithNonLocalSession(state);
      }
    }
    writeInternal(qm.message,qm.id,qm.timestamp);
    completed++;
    if (flush)     out.flush();
  }
 catch (  Exception e) {
    disconnect();
    if (e instanceof IOException) {
      if (logger.isDebugEnabled())       logger.debug("error writing to {}",poolReference.endPoint(),e);
      if (qm.shouldRetry()) {
        try {
          backlog.put(new RetriedQueuedMessage(qm));
        }
 catch (        InterruptedException e1) {
          throw new AssertionError(e1);
        }
      }
    }
 else {
      logger.error("error writing to {}",poolReference.endPoint(),e);
    }
  }
}
