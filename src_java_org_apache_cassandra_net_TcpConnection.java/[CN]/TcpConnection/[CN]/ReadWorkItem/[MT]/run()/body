{
  if (tcpReader_ == null) {
    tcpReader_=new TcpReader(TcpConnection.this);
    StartState nextState=tcpReader_.getSocketState(TcpReader.TcpReaderState.PREAMBLE);
    if (nextState == null) {
      nextState=new ProtocolState(tcpReader_);
      tcpReader_.putSocketState(TcpReader.TcpReaderState.PREAMBLE,nextState);
    }
    tcpReader_.morphState(nextState);
  }
  try {
    byte[] bytes;
    while ((bytes=tcpReader_.read()).length > 0) {
      ProtocolHeader pH=tcpReader_.getProtocolHeader();
      if (!pH.isStreamingMode_) {
        if (remoteEp_ == null) {
          remoteEp_=new EndPoint(socketChannel_.socket().getInetAddress().getHostAddress(),DatabaseDescriptor.getStoragePort());
          pool_=MessagingService.getConnectionPool(localEp_,remoteEp_);
          pool_.addToPool(TcpConnection.this);
        }
        MessagingService.getDeserializationExecutor().submit(new MessageDeserializationTask(pH.serializerType_,bytes));
        tcpReader_.resetState();
      }
 else {
        MessagingService.setStreamingMode(false);
        closeSocket();
      }
    }
  }
 catch (  IOException ex) {
    handleException(ex);
  }
catch (  Throwable th) {
    handleException(th);
  }
 finally {
    if (key_.isValid())     turnOnInterestOps(key_,SelectionKey.OP_READ);
  }
}
