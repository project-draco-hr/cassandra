{
  activeSegments.remove(segment);
  if (!CommitLog.instance.archiver.maybeWaitForArchiving(segment.getName())) {
    discardSegment(segment,false);
    return;
  }
  if (isCapExceeded()) {
    discardSegment(segment,true);
    return;
  }
  queue.add(new Runnable(){
    public void run(){
      CommitLogSegment recycled=segment.recycle();
      internalAddReadySegment(recycled);
    }
  }
);
}
