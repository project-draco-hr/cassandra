{
  Keyspace keyspace=Keyspace.open(KEYSPACE);
  ColumnFamilyStore cfs=keyspace.getColumnFamilyStore(CF1);
  cfs.truncateBlocking();
  ByteBuffer rowKey=ByteBufferUtil.bytes("k1");
  DecoratedKey key=DatabaseDescriptor.getPartitioner().decorateKey(rowKey);
  long timestamp1=FBUtilities.timestampMicros();
  long timestamp2=timestamp1 - 5;
  long timestamp3=timestamp2 - 5;
  applyMutation(CF1,rowKey,timestamp1);
  try (CompactionController controller=new CompactionController(cfs,null,0)){
    assertEquals(timestamp1,controller.maxPurgeableTimestamp(key));
    cfs.forceBlockingFlush();
    assertEquals(Long.MAX_VALUE,controller.maxPurgeableTimestamp(key));
  }
   Set<SSTableReader> compacting=Sets.newHashSet(cfs.getSSTables());
  applyMutation(CF1,rowKey,timestamp2);
  cfs.forceBlockingFlush();
  try (CompactionController controller=new CompactionController(cfs,compacting,0)){
    assertEquals(timestamp2,controller.maxPurgeableTimestamp(key));
    applyMutation(CF1,rowKey,timestamp3);
    assertEquals(timestamp3,controller.maxPurgeableTimestamp(key));
  }
   cfs.forceBlockingFlush();
  try (CompactionController controller=new CompactionController(cfs,null,0)){
    applyMutation(CF1,rowKey,timestamp1);
    applyMutation(CF1,rowKey,timestamp2);
    applyMutation(CF1,rowKey,timestamp3);
    assertEquals(timestamp3,controller.maxPurgeableTimestamp(key));
  }
   cfs.forceBlockingFlush();
  try (CompactionController controller=new CompactionController(cfs,null,0)){
    applyMutation(CF1,rowKey,timestamp3);
    applyMutation(CF1,rowKey,timestamp2);
    applyMutation(CF1,rowKey,timestamp1);
    assertEquals(timestamp3,controller.maxPurgeableTimestamp(key));
  }
 }
