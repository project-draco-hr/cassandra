{
  if (!usesSecondaryIndexing || restrictedColumns.isEmpty())   return Collections.emptyList();
  List<IndexExpression> expressions=new ArrayList<IndexExpression>();
  for (  ColumnDefinition def : restrictedColumns) {
    Restriction restriction;
switch (def.kind) {
case PARTITION_KEY:
      restriction=keyRestrictions[def.position()];
    break;
case CLUSTERING_COLUMN:
  restriction=columnRestrictions[def.position()];
break;
case REGULAR:
restriction=metadataRestrictions.get(def.name);
break;
default :
throw new AssertionError();
}
if (restriction.isSlice()) {
Restriction.Slice slice=(Restriction.Slice)restriction;
for (Bound b : Bound.values()) {
if (slice.hasBound(b)) {
ByteBuffer value=slice.bound(b,variables);
if (value == null) throw new InvalidRequestException(String.format("Unsupported null value for indexed column %s",def.name));
if (value.remaining() > 0xFFFF) throw new InvalidRequestException("Index expression values may not be larger than 64K");
expressions.add(new IndexExpression(def.name.bytes,slice.getIndexOperator(b),value));
}
}
}
 else {
List<ByteBuffer> values=restriction.values(variables);
if (values.size() != 1) throw new InvalidRequestException("IN restrictions are not supported on indexed columns");
ByteBuffer value=values.get(0);
if (value == null) throw new InvalidRequestException(String.format("Unsupported null value for indexed column %s",def.name));
if (value.remaining() > 0xFFFF) throw new InvalidRequestException("Index expression values may not be larger than 64K");
expressions.add(new IndexExpression(def.name.bytes,IndexExpression.Operator.EQ,value));
}
}
return expressions;
}
