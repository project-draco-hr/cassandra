{
  LeveledCompactionTask currentTask=task.get();
  if (currentTask != null && !currentTask.isDone()) {
    logger.debug("Compaction still in progress for {}",this);
    return null;
  }
  Collection<SSTableReader> sstables=manifest.getCompactionCandidates();
  OperationType op=OperationType.COMPACTION;
  if (sstables.isEmpty()) {
    SSTableReader sstable=findDroppableSSTable(gcBefore);
    if (sstable == null) {
      logger.debug("No compaction necessary for {}",this);
      return null;
    }
    sstables=Collections.singleton(sstable);
    op=OperationType.TOMBSTONE_COMPACTION;
  }
  LeveledCompactionTask newTask=new LeveledCompactionTask(cfs,sstables,gcBefore,this.maxSSTableSizeInMB);
  newTask.setCompactionType(op);
  return task.compareAndSet(currentTask,newTask) ? newTask : null;
}
