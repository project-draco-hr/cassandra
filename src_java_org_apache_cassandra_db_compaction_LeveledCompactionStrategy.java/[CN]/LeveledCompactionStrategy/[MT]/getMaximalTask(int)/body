{
  while (true) {
    Collection<SSTableReader> sstables=manifest.getCompactionCandidates();
    OperationType op=OperationType.COMPACTION;
    if (sstables.isEmpty()) {
      SSTableReader sstable=findDroppableSSTable(gcBefore);
      if (sstable == null) {
        logger.debug("No compaction necessary for {}",this);
        return null;
      }
      sstables=Collections.singleton(sstable);
      op=OperationType.TOMBSTONE_COMPACTION;
    }
    if (cfs.getDataTracker().markCompacting(sstables)) {
      LeveledCompactionTask newTask=new LeveledCompactionTask(cfs,sstables,gcBefore,maxSSTableSizeInMB);
      newTask.setCompactionType(op);
      return newTask;
    }
  }
}
