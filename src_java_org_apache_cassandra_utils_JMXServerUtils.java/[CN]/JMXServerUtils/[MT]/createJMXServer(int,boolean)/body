{
  Map<String,Object> env=new HashMap<>();
  String urlTemplate="service:jmx:rmi://%1$s/jndi/rmi://%1$s:%2$d/jmxrmi";
  InetAddress serverAddress=null;
  if (local) {
    serverAddress=InetAddress.getLoopbackAddress();
    System.setProperty("java.rmi.server.hostname",serverAddress.getHostAddress());
  }
  env.putAll(configureJmxSocketFactories(serverAddress));
  String url=String.format(urlTemplate,(serverAddress != null ? serverAddress.getHostAddress() : "0.0.0.0"),port);
  LocateRegistry.createRegistry(port,(RMIClientSocketFactory)env.get(RMIConnectorServer.RMI_CLIENT_SOCKET_FACTORY_ATTRIBUTE),(RMIServerSocketFactory)env.get(RMIConnectorServer.RMI_SERVER_SOCKET_FACTORY_ATTRIBUTE));
  env.putAll(configureJmxAuthentication());
  MBeanServerForwarder authzProxy=configureJmxAuthorization(env);
  env.put(RMIExporter.EXPORTER_ATTRIBUTE,new Exporter());
  JMXConnectorServer jmxServer=JMXConnectorServerFactory.newJMXConnectorServer(new JMXServiceURL(url),env,ManagementFactory.getPlatformMBeanServer());
  if (authzProxy != null)   jmxServer.setMBeanServerForwarder(authzProxy);
  logger.info("Configured JMX server at: {}",url);
  return jmxServer;
}
