{
  List<KSMetaData> ksms=new ArrayList<KSMetaData>();
  for (  String tableName : DatabaseDescriptor.getNonSystemTables()) {
    if (remove != null && remove.name.equals(tableName) || add != null && add.name.equals(tableName))     continue;
    ksms.add(DatabaseDescriptor.getTableDefinition(tableName));
  }
  if (add != null)   ksms.add(add);
  RowMutation rm=new RowMutation(Table.SYSTEM_TABLE,toUTF8Bytes(versionId));
  long now=System.currentTimeMillis();
  for (  KSMetaData ksm : ksms)   rm.add(new QueryPath(SCHEMA_CF,null,ksm.name.getBytes(UTF_8)),SerDeUtils.serialize(ksm.deflate()),now);
  rm.add(new QueryPath(SCHEMA_CF,null,DefsTable.DEFINITION_SCHEMA_COLUMN_NAME),org.apache.cassandra.avro.KsDef.SCHEMA$.toString().getBytes(UTF_8),now);
  return rm;
}
