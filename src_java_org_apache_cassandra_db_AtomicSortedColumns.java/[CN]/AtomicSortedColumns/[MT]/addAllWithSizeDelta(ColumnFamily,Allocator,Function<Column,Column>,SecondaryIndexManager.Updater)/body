{
  Holder current, modified;
  long sizeDelta;
  main_loop:   do {
    sizeDelta=0;
    current=ref.get();
    DeletionInfo newDelInfo=current.deletionInfo.copy().add(cm.deletionInfo());
    modified=new Holder(current.map.clone(),newDelInfo);
    if (cm.deletionInfo().hasRanges()) {
      for (      Column currentColumn : Iterables.concat(current.map.values(),cm)) {
        if (cm.deletionInfo().isDeleted(currentColumn))         indexer.remove(currentColumn);
      }
    }
    for (    Column column : cm) {
      sizeDelta+=modified.addColumn(transformation.apply(column),allocator,indexer);
      if (ref.get() != current)       continue main_loop;
    }
  }
 while (!ref.compareAndSet(current,modified));
  indexer.updateRowLevelIndexes();
  return sizeDelta;
}
