{
  Holder current, modified;
  main_loop:   do {
    current=ref.get();
    DeletionInfo newDelInfo=current.deletionInfo;
    if (newDelInfo.markedForDeleteAt < cm.getDeletionInfo().markedForDeleteAt)     newDelInfo=cm.getDeletionInfo();
    modified=new Holder(current.map.clone(),newDelInfo);
    for (    IColumn column : cm.getSortedColumns()) {
      modified.addColumn(transformation.apply(column),allocator);
      if (ref.get() != current)       continue main_loop;
    }
  }
 while (!ref.compareAndSet(current,modified));
}
