{
  long startTime=System.currentTimeMillis();
  Message message=null;
  try {
    message=rm.makeRowMutationMessage();
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  try {
    EndPoint[] naturalEndpoints=StorageService.instance().getReadStorageEndPoints(rm.key());
    Map<EndPoint,EndPoint> endpointMap=StorageService.instance().getHintedStorageEndpointMap(rm.key(),naturalEndpoints);
    int blockFor=determineBlockFor(naturalEndpoints.length,endpointMap.size(),consistency_level);
    List<EndPoint> primaryNodes=getUnhintedNodes(endpointMap);
    if (primaryNodes.size() < blockFor) {
      throw new UnavailableException();
    }
    QuorumResponseHandler<Boolean> quorumResponseHandler=new QuorumResponseHandler<Boolean>(blockFor,new WriteResponseResolver());
    if (logger.isDebugEnabled())     logger.debug("insertBlocking writing key " + rm.key() + " to "+ message.getMessageId()+ "@["+ StringUtils.join(endpointMap.keySet(),", ")+ "]");
    MessagingService.instance().sendRR(message,primaryNodes.toArray(new EndPoint[primaryNodes.size()]),quorumResponseHandler);
    if (!quorumResponseHandler.get())     throw new UnavailableException();
    if (primaryNodes.size() < endpointMap.size()) {
      for (      Map.Entry<EndPoint,EndPoint> e : endpointMap.entrySet()) {
        if (e.getKey() != e.getValue()) {
          MessagingService.instance().sendOneWay(message,e.getKey());
        }
      }
    }
  }
 catch (  Exception e) {
    logger.error("error writing key " + rm.key(),e);
    throw new UnavailableException();
  }
 finally {
    writeStats.add(System.currentTimeMillis() - startTime);
  }
}
