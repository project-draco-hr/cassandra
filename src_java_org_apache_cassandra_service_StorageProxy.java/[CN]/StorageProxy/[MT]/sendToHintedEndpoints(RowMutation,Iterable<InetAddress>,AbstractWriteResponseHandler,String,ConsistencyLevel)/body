{
  Map<String,Collection<InetAddress>> dcGroups=null;
  MessageOut<RowMutation> message=null;
  for (  InetAddress destination : targets) {
    if (totalHintsInProgress.get() > maxHintsInProgress && (hintsInProgress.get(destination).get() > 0 && shouldHint(destination))) {
      throw new OverloadedException("Too many in flight hints: " + totalHintsInProgress.get());
    }
    if (FailureDetector.instance.isAlive(destination)) {
      if (destination.equals(FBUtilities.getBroadcastAddress()) && OPTIMIZE_LOCAL_REQUESTS) {
        insertLocal(rm,responseHandler);
      }
 else {
        if (message == null)         message=rm.createMessage();
        String dc=DatabaseDescriptor.getEndpointSnitch().getDatacenter(destination);
        if (localDataCenter.equals(dc) || MessagingService.instance().getVersion(destination) < MessagingService.VERSION_20) {
          MessagingService.instance().sendRR(message,destination,responseHandler);
        }
 else {
          Collection<InetAddress> messages=(dcGroups != null) ? dcGroups.get(dc) : null;
          if (messages == null) {
            messages=new ArrayList<InetAddress>(3);
            if (dcGroups == null)             dcGroups=new HashMap<String,Collection<InetAddress>>();
            dcGroups.put(dc,messages);
          }
          messages.add(destination);
        }
      }
    }
 else {
      if (!shouldHint(destination))       continue;
      submitHint(rm,destination,responseHandler,consistency_level);
    }
  }
  if (dcGroups != null) {
    if (message == null)     message=rm.createMessage();
    for (    Collection<InetAddress> dcTargets : dcGroups.values()) {
      message=message.withHeaderRemoved(RowMutation.FORWARD_TO);
      sendMessagesToNonlocalDC(message,dcTargets,responseHandler);
    }
  }
}
