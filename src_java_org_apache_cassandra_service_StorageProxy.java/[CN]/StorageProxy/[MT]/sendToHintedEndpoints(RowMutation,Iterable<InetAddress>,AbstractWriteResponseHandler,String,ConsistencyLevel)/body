{
  Map<String,Multimap<MessageOut,InetAddress>> dcMessages=null;
  for (  InetAddress destination : targets) {
    if (totalHintsInProgress.get() > maxHintsInProgress && (hintsInProgress.get(destination).get() > 0 && shouldHint(destination))) {
      throw new OverloadedException("Too many in flight hints: " + totalHintsInProgress.get());
    }
    if (FailureDetector.instance.isAlive(destination)) {
      if (destination.equals(FBUtilities.getBroadcastAddress()) && OPTIMIZE_LOCAL_REQUESTS) {
        insertLocal(rm,responseHandler);
      }
 else {
        if (logger.isTraceEnabled())         logger.trace("insert writing key " + ByteBufferUtil.bytesToHex(rm.key()) + " to "+ destination);
        String dc=DatabaseDescriptor.getEndpointSnitch().getDatacenter(destination);
        Multimap<MessageOut,InetAddress> messages=(dcMessages != null) ? dcMessages.get(dc) : null;
        if (messages == null) {
          messages=HashMultimap.create();
          if (dcMessages == null)           dcMessages=new HashMap<String,Multimap<MessageOut,InetAddress>>();
          dcMessages.put(dc,messages);
        }
        messages.put(rm.createMessage(),destination);
      }
    }
 else {
      if (!shouldHint(destination))       continue;
      submitHint(rm,destination,responseHandler,consistency_level);
    }
  }
  if (dcMessages != null) {
    for (    Map.Entry<String,Multimap<MessageOut,InetAddress>> entry : dcMessages.entrySet()) {
      boolean isLocalDC=entry.getKey().equals(localDataCenter);
      for (      Map.Entry<MessageOut,Collection<InetAddress>> messages : entry.getValue().asMap().entrySet()) {
        MessageOut message=messages.getKey();
        Collection<InetAddress> targets1=messages.getValue();
        message=message.withHeaderRemoved(RowMutation.FORWARD_TO);
        sendMessagesToOneDC(message,targets1,isLocalDC,responseHandler);
      }
    }
  }
}
