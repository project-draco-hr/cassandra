{
  TokenMetadata tokenMetadata=StorageService.instance.getTokenMetadata();
  if (logger.isDebugEnabled())   logger.debug("computing restricted ranges for query " + queryRange);
  List<AbstractBounds> ranges=new ArrayList<AbstractBounds>();
  for (  Token nodeToken : tokenMetadata.sortedTokens()) {
    Range nodeRange=new Range(tokenMetadata.getPredecessor(nodeToken),nodeToken);
    for (    AbstractBounds range : queryRange.restrictTo(nodeRange)) {
      for (      AbstractBounds unwrapped : range.unwrap()) {
        if (logger.isDebugEnabled())         logger.debug("Adding to restricted ranges " + unwrapped + " for "+ nodeRange);
        ranges.add(unwrapped);
      }
    }
  }
  Comparator<AbstractBounds> comparator=new Comparator<AbstractBounds>(){
    public int compare(    AbstractBounds o1,    AbstractBounds o2){
      int queryOrder1=queryRange.left.compareTo(o1.left);
      int queryOrder2=queryRange.left.compareTo(o2.left);
      if (queryOrder1 < queryOrder2)       return -1;
      if (queryOrder1 > queryOrder2)       return 1;
      return o1.left.compareTo(o2.left);
    }
  }
;
  Collections.sort(ranges,comparator);
  if (logger.isDebugEnabled())   logger.debug("Sorted ranges are [" + StringUtils.join(ranges,", ") + "]");
  return ranges;
}
