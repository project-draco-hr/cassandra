{
  TokenMetadata tmd=StorageService.instance.getTokenMetadata();
  Set<InetAddress> expected=addTokens(1 + Keyspace.open(keyspaceName).getReplicationStrategy().getReplicationFactor());
  expected.remove(FBUtilities.getBroadcastAddress());
  TokenMetadata.Topology topology=tmd.cloneOnlyTokenMap().getTopology();
  HashSet<InetAddress> localEndpoints=Sets.newHashSet(topology.getDatacenterEndpoints().get(DatabaseDescriptor.getLocalDataCenter()));
  expected=Sets.intersection(expected,localEndpoints);
  Collection<Range<Token>> ranges=StorageService.instance.getLocalRanges(keyspaceName);
  Set<InetAddress> neighbors=new HashSet<InetAddress>();
  for (  Range<Token> range : ranges) {
    neighbors.addAll(ActiveRepairService.getNeighbors(keyspaceName,range,Arrays.asList(DatabaseDescriptor.getLocalDataCenter()),null));
  }
  assertEquals(expected,neighbors);
}
