{
  TokenMetadata tmd=StorageService.instance.getTokenMetadata();
  addTokens(2 * Table.open(tablename).getReplicationStrategy().getReplicationFactor());
  AbstractReplicationStrategy ars=Table.open(tablename).getReplicationStrategy();
  Set<InetAddress> expected=new HashSet<InetAddress>();
  for (  Range<Token> replicaRange : ars.getAddressRanges().get(FBUtilities.getBroadcastAddress())) {
    expected.addAll(ars.getRangeAddresses(tmd.cloneOnlyTokenMap()).get(replicaRange));
  }
  expected.remove(FBUtilities.getBroadcastAddress());
  TokenMetadata.Topology topology=tmd.cloneOnlyTokenMap().getTopology();
  HashSet<InetAddress> localEndpoints=Sets.newHashSet(topology.getDatacenterEndpoints().get(DatabaseDescriptor.getLocalDataCenter()));
  expected=Sets.intersection(expected,localEndpoints);
  Collection<Range<Token>> ranges=StorageService.instance.getLocalRanges(tablename);
  Set<InetAddress> neighbors=new HashSet<InetAddress>();
  for (  Range<Token> range : ranges) {
    neighbors.addAll(AntiEntropyService.getNeighbors(tablename,range,true));
  }
  assertEquals(expected,neighbors);
}
