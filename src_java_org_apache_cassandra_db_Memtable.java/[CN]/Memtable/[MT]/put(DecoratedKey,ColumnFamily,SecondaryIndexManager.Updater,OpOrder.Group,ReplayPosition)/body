{
  if (replayPosition != null && writeBarrier != null) {
    while (true) {
      ReplayPosition last=lastReplayPosition.get();
      if (last.compareTo(replayPosition) >= 0)       break;
      if (lastReplayPosition.compareAndSet(last,replayPosition))       break;
    }
  }
  AtomicBTreeColumns previous=rows.get(key);
  if (previous == null) {
    AtomicBTreeColumns empty=cf.cloneMeShallow(AtomicBTreeColumns.factory,false);
    final DecoratedKey cloneKey=allocator.clone(key,opGroup);
    previous=rows.putIfAbsent(cloneKey,empty);
    if (previous == null) {
      previous=empty;
      int overhead=(int)(key.getToken().getHeapSize() + ROW_OVERHEAD_HEAP_SIZE);
      allocator.onHeap().allocate(overhead,opGroup);
    }
 else {
      allocator.reclaimer().reclaimImmediately(cloneKey);
    }
  }
  final Pair<Long,Long> pair=previous.addAllWithSizeDelta(cf,allocator,opGroup,indexer);
  liveDataSize.addAndGet(pair.left);
  currentOperations.addAndGet(cf.getColumnCount() + (cf.isMarkedForDelete() ? 1 : 0) + cf.deletionInfo().rangeCount());
  return pair.right;
}
