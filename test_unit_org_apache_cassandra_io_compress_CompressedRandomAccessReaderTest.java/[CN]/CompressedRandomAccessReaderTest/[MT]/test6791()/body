{
  File f=File.createTempFile("compressed6791_","3");
  String filename=f.getAbsolutePath();
  try (ChannelProxy channel=new ChannelProxy(f)){
    MetadataCollector sstableMetadataCollector=new MetadataCollector(new ClusteringComparator(BytesType.instance));
    try (CompressedSequentialWriter writer=new CompressedSequentialWriter(f,filename + ".metadata",CompressionParams.snappy(32),sstableMetadataCollector)){
      for (int i=0; i < 20; i++)       writer.write("x".getBytes());
      DataPosition mark=writer.mark();
      for (int i=0; i < 40; ++i)       writer.write("y".getBytes());
      writer.resetAndTruncate(mark);
      for (int i=0; i < 20; i++)       writer.write("x".getBytes());
      writer.finish();
    }
     try (RandomAccessReader reader=RandomAccessReader.builder(channel).compression(new CompressionMetadata(filename + ".metadata",f.length(),ChecksumType.CRC32)).build()){
      String res=reader.readLine();
      assertEquals(res,"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx");
      assertEquals(40,res.length());
    }
   }
  finally {
    if (f.exists())     assertTrue(f.delete());
    File metadata=new File(filename + ".metadata");
    if (metadata.exists())     metadata.delete();
  }
}
