{
  DataInputBuffer bufIn=new DataInputBuffer();
  for (  File file : clogs) {
    int bufferSize=(int)Math.min(file.length(),32 * 1024 * 1024);
    BufferedRandomAccessFile reader=new BufferedRandomAccessFile(file.getAbsolutePath(),"r",bufferSize);
    CommitLogHeader clHeader=readCommitLogHeader(reader);
    int lowPos=CommitLogHeader.getLowestPosition(clHeader);
    if (lowPos == 0)     break;
    reader.seek(lowPos);
    if (logger_.isDebugEnabled())     logger_.debug("Replaying " + file + " starting at "+ lowPos);
    Set<Table> tablesRecovered=new HashSet<Table>();
    while (!reader.isEOF()) {
      if (logger_.isDebugEnabled())       logger_.debug("Reading mutation at " + reader.getFilePointer());
      byte[] bytes;
      try {
        bytes=new byte[(int)reader.readLong()];
        if (reader.read(bytes) < bytes.length) {
          throw new EOFException();
        }
      }
 catch (      EOFException e) {
        break;
      }
      bufIn.reset(bytes,bytes.length);
      RowMutation rm=RowMutation.serializer().deserialize(bufIn);
      if (logger_.isDebugEnabled())       logger_.debug(String.format("replaying mutation for %s.%s: %s",rm.getTable(),rm.key(),"{" + StringUtils.join(rm.getColumnFamilies(),", ") + "}"));
      Table table=Table.open(rm.getTable());
      tablesRecovered.add(table);
      Collection<ColumnFamily> columnFamilies=new ArrayList<ColumnFamily>(rm.getColumnFamilies());
      for (      ColumnFamily columnFamily : columnFamilies) {
        int id=table.getColumnFamilyId(columnFamily.name());
        if (!clHeader.isDirty(id) || reader.getFilePointer() < clHeader.getPosition(id)) {
          rm.removeColumnFamily(columnFamily);
        }
      }
      if (!rm.isEmpty()) {
        table.applyNow(rm);
      }
    }
    reader.close();
    for (    Table table : tablesRecovered) {
      table.flush(true);
    }
  }
}
