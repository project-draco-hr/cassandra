{
  EstimatedHistogram rowSizes=SSTable.defaultRowHistogram();
  EstimatedHistogram columnCounts=SSTable.defaultColumnHistogram();
  long rows=0;
  DecoratedKey key;
  long rowPosition=0;
  while (rowPosition < dfile.length()) {
    key=SSTableReader.decodeKey(StorageService.getPartitioner(),desc,ByteBufferUtil.readWithShortLength(dfile));
    iwriter.afterAppend(key,rowPosition);
    long dataSize=SSTableReader.readRowSize(dfile,desc);
    rowPosition=dfile.getFilePointer() + dataSize;
    IndexHelper.skipBloomFilter(dfile);
    IndexHelper.skipIndex(dfile);
    ColumnFamily.serializer().deserializeFromSSTableNoColumns(ColumnFamily.create(cfs.metadata),dfile);
    updateCache(key,dataSize,null);
    rowSizes.add(dataSize);
    columnCounts.add(dfile.readInt());
    dfile.seek(rowPosition);
    rows++;
  }
  writeMetadata(desc,rowSizes,columnCounts,ReplayPosition.NONE);
  return rows;
}
