{
  EstimatedHistogram rowSizes=SSTable.defaultRowHistogram();
  EstimatedHistogram columnCounts=SSTable.defaultColumnHistogram();
  long rows=0L;
  DecoratedKey key;
  CompactionController controller=new CompactionController(cfs,Collections.<SSTableReader>emptyList(),Integer.MAX_VALUE,true);
  while (!dfile.isEOF()) {
    key=SSTableReader.decodeKey(StorageService.getPartitioner(),desc,ByteBufferUtil.readWithShortLength(dfile));
    long dataSize=SSTableReader.readRowSize(dfile,desc);
    SSTableIdentityIterator iter=new SSTableIdentityIterator(cfs.metadata,dfile,key,dfile.getFilePointer(),dataSize,true);
    AbstractCompactedRow row=controller.getCompactedRow(iter);
    updateCache(key,dataSize,row);
    rowSizes.add(dataSize);
    columnCounts.add(row.columnCount());
    iwriter.afterAppend(key,writerDfile.getFilePointer());
    ByteBufferUtil.writeWithShortLength(key.key,writerDfile);
    row.write(writerDfile);
    rows++;
  }
  writeMetadata(desc,rowSizes,columnCounts,ReplayPosition.NONE);
  if (writerDfile.getFilePointer() != dfile.getFilePointer()) {
    writerDfile.setLength(writerDfile.getFilePointer());
  }
  writerDfile.sync();
  return rows;
}
