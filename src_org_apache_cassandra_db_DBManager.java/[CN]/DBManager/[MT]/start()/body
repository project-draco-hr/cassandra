{
  StorageMetadata storageMetadata=null;
  SystemTable sysTable=SystemTable.openSystemTable(SystemTable.name_);
  Row row=sysTable.get(FBUtilities.getHostName());
  IPartitioner p=StorageService.getPartitioner();
  if (row == null) {
    Token token=p.getDefaultToken();
    int generation=1;
    String key=FBUtilities.getHostName();
    row=new Row(key);
    ColumnFamily cf=new ColumnFamily(SystemTable.cfName_);
    cf.addColumn(new Column(SystemTable.token_,p.getTokenFactory().toByteArray(token)));
    cf.addColumn(new Column(SystemTable.generation_,BasicUtilities.intToByteArray(generation)));
    row.addColumnFamily(cf);
    sysTable.apply(row);
    storageMetadata=new StorageMetadata(token,generation);
  }
 else {
    Map<String,ColumnFamily> columnFamilies=row.getColumnFamilyMap();
    Set<String> cfNames=columnFamilies.keySet();
    for (    String cfName : cfNames) {
      ColumnFamily columnFamily=columnFamilies.get(cfName);
      IColumn tokenColumn=columnFamily.getColumn(SystemTable.token_);
      Token token=p.getTokenFactory().fromByteArray(tokenColumn.value());
      IColumn generation=columnFamily.getColumn(SystemTable.generation_);
      int gen=BasicUtilities.byteArrayToInt(generation.value()) + 1;
      Column generation2=new Column("Generation",BasicUtilities.intToByteArray(gen),generation.timestamp() + 1);
      columnFamily.addColumn(generation2);
      storageMetadata=new StorageMetadata(token,gen);
      break;
    }
    sysTable.reset(row);
  }
  return storageMetadata;
}
