{
  Map<Token,EndPoint> tokenToEndPointMap=tokenMetadata_.cloneTokenEndPointMap();
  for (  Token token : tokens_) {
    tokenToEndPointMap.remove(token);
  }
  Set<Token> oldTokens=new HashSet<Token>(tokenToEndPointMap.keySet());
  Range[] oldRanges=StorageService.instance().getAllRanges(oldTokens);
  if (logger_.isDebugEnabled())   logger_.debug("Total number of old ranges " + oldRanges.length);
  Map<Range,List<Range>> splitRanges=LeaveJoinProtocolHelper.getRangeSplitRangeMapping(oldRanges,tokens_);
  Map<Range,List<EndPoint>> oldRangeToEndPointMap=StorageService.instance().constructRangeToEndPointMap(oldRanges,tokenToEndPointMap);
  Map<Range,List<EndPoint>> replicasForSplitRanges=new HashMap<Range,List<EndPoint>>();
  Set<Range> rangesSplit=splitRanges.keySet();
  for (  Range splitRange : rangesSplit) {
    replicasForSplitRanges.put(splitRange,oldRangeToEndPointMap.get(splitRange));
  }
  for (  Range splitRange : rangesSplit) {
    oldRangeToEndPointMap.remove(splitRange);
  }
  for (  Range splitRange : rangesSplit) {
    List<Range> subRanges=splitRanges.get(splitRange);
    List<EndPoint> replicas=replicasForSplitRanges.get(splitRange);
    for (    Range subRange : subRanges) {
      oldRangeToEndPointMap.put(subRange,new ArrayList<EndPoint>(replicas));
    }
  }
  Collections.addAll(oldTokens,tokens_);
  Range[] newRanges=StorageService.instance().getAllRanges(oldTokens);
  if (logger_.isDebugEnabled())   logger_.debug("Total number of new ranges " + newRanges.length);
  Map<Range,List<EndPoint>> newRangeToEndPointMap=StorageService.instance().constructRangeToEndPointMap(newRanges);
  Map<Range,List<BootstrapSourceTarget>> rangesWithSourceTarget=LeaveJoinProtocolHelper.getRangeSourceTargetInfo(oldRangeToEndPointMap,newRangeToEndPointMap);
  return rangesWithSourceTarget;
}
