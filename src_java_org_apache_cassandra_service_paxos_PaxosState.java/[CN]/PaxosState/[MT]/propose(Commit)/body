{
  Lock lock=LOCKS.get(proposal.key);
  lock.lock();
  try {
    PaxosState state=SystemKeyspace.loadPaxosState(proposal.key,proposal.update.metadata());
    if (proposal.hasBallot(state.promised.ballot) || proposal.isAfter(state.promised)) {
      Tracing.trace("Accepting proposal {}",proposal);
      SystemKeyspace.savePaxosProposal(proposal);
      return true;
    }
 else {
      Tracing.trace("Rejecting proposal for {} because inProgress is now {}",proposal,state.promised);
      return false;
    }
  }
  finally {
    lock.unlock();
  }
}
