{
synchronized (lockFor(toPrepare.key)) {
    PaxosState state=SystemTable.loadPaxosState(toPrepare.key,toPrepare.update.metadata());
    if (toPrepare.isAfter(state.inProgressCommit)) {
      logger.debug("promising ballot {}",toPrepare.ballot);
      SystemTable.savePaxosPromise(toPrepare);
      return new PrepareResponse(true,state.inProgressCommit,state.mostRecentCommit);
    }
 else {
      logger.debug("promise rejected; {} is not sufficiently newer than {}",toPrepare,state.inProgressCommit);
      return new PrepareResponse(false,state.inProgressCommit,state.mostRecentCommit);
    }
  }
}
