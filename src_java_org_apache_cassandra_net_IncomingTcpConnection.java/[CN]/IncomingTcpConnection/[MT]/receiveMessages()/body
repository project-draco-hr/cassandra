{
  DataOutputStream out=new DataOutputStream(socket.getOutputStream());
  out.writeInt(MessagingService.current_version);
  out.flush();
  DataInput in=new DataInputStream(socket.getInputStream());
  int maxVersion=in.readInt();
  from=CompactEndpointSerializationHelper.deserialize(in);
  MessagingService.instance().setVersion(from,maxVersion);
  logger.debug("Set version for {} to {} (will use {})",from,maxVersion,MessagingService.instance().getVersion(from));
  if (compressed) {
    logger.debug("Upgrading incoming connection to be compressed");
    if (version < MessagingService.VERSION_21) {
      in=new DataInputStream(new SnappyInputStream(socket.getInputStream()));
    }
 else {
      LZ4FastDecompressor decompressor=LZ4Factory.fastestInstance().fastDecompressor();
      Checksum checksum=XXHashFactory.fastestInstance().newStreamingHash32(OutboundTcpConnection.LZ4_HASH_SEED).asChecksum();
      in=new DataInputStream(new LZ4BlockInputStream(socket.getInputStream(),decompressor,checksum));
    }
  }
 else {
    in=new NIODataInputStream(socket.getChannel(),BUFFER_SIZE);
  }
  if (version > MessagingService.current_version) {
    Gossiper.instance.addSavedEndpoint(from);
    logger.info("Received messages from newer protocol version {}. Ignoring",version);
    return;
  }
  while (true) {
    MessagingService.validateMagic(in.readInt());
    receiveMessage(in,version);
  }
}
