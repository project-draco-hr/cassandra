{
  long start=System.currentTimeMillis();
  File path=getCachePath();
  if (keys.size() == 0 || estimatedTotalBytes == 0) {
    logger.debug("Deleting {} (cache is empty)");
    path.delete();
    return;
  }
  logger.debug("Saving {}",path);
  File tmpFile=File.createTempFile(path.getName(),null,path.getParentFile());
  DataOutputStream out=SequentialWriter.open(tmpFile,true).stream;
  try {
    for (    K key : keys) {
      if (isStopped())       throw new UserInterruptedException(getCompactionInfo());
      ByteBuffer bytes=translateKey(key);
      ByteBufferUtil.writeWithLength(bytes,out);
      bytesWritten+=bytes.remaining();
    }
    out.flush();
    path.delete();
    if (!tmpFile.renameTo(path))     throw new IOException("Unable to rename " + tmpFile + " to "+ path);
    logger.info(String.format("Saved %s (%d items) in %d ms",path.getName(),keys.size(),(System.currentTimeMillis() - start)));
  }
  finally {
    FileUtils.closeQuietly(out);
    if (tmpFile.exists())     tmpFile.delete();
  }
}
