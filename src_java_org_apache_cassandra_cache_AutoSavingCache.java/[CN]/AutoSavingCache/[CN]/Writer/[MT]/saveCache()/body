{
  logger.debug("Deleting old {} files.",cacheType);
  deleteOldCacheFiles();
  if (keys.isEmpty()) {
    logger.debug("Skipping {} save, cache is empty.",cacheType);
    return;
  }
  long start=System.nanoTime();
  DataOutputStreamPlus writer=null;
  File tempCacheFile=tempCacheFile();
  try {
    try {
      writer=new DataOutputStreamPlus(streamFactory.getOutputStream(tempCacheFile));
    }
 catch (    FileNotFoundException e) {
      throw new RuntimeException(e);
    }
    try {
      UUID schemaVersion=Schema.instance.getVersion();
      if (schemaVersion == null) {
        Schema.instance.updateVersion();
        schemaVersion=Schema.instance.getVersion();
      }
      writer.writeLong(schemaVersion.getMostSignificantBits());
      writer.writeLong(schemaVersion.getLeastSignificantBits());
      for (      K key : keys) {
        ColumnFamilyStore cfs=Schema.instance.getColumnFamilyStoreIncludingIndexes(key.ksAndCFName);
        if (cfs == null)         continue;
        cacheLoader.serialize(key,writer,cfs);
        keysWritten++;
      }
    }
 catch (    IOException e) {
      throw new FSWriteError(e,tempCacheFile);
    }
  }
  finally {
    if (writer != null)     FileUtils.closeQuietly(writer);
  }
  File cacheFile=getCachePath(CURRENT_VERSION);
  cacheFile.delete();
  if (!tempCacheFile.renameTo(cacheFile))   logger.error("Unable to rename {} to {}",tempCacheFile,cacheFile);
  logger.info("Saved {} ({} items) in {} ms",cacheType,keys.size(),TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start));
}
