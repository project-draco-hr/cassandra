{
  long start=System.currentTimeMillis();
  File path=getCachePath();
  if (keys.size() == 0 || estimatedTotalBytes == 0) {
    logger.debug("Deleting {} (cache is empty)");
    path.delete();
    return;
  }
  logger.debug("Saving {}",path);
  File tmpFile=File.createTempFile(path.getName(),null,path.getParentFile());
  BufferedRandomAccessFile out=new BufferedRandomAccessFile(tmpFile,"rw",BufferedRandomAccessFile.DEFAULT_BUFFER_SIZE,true);
  try {
    for (    K key : keys) {
      ByteBuffer bytes=translateKey(key);
      ByteBufferUtil.writeWithLength(bytes,out);
      bytesWritten+=bytes.remaining();
    }
  }
  finally {
    out.close();
  }
  path.delete();
  if (!tmpFile.renameTo(path))   throw new IOException("Unable to rename " + tmpFile + " to "+ path);
  logger.info(String.format("Saved %s (%d items) in %d ms",path.getName(),keys.size(),(System.currentTimeMillis() - start)));
}
