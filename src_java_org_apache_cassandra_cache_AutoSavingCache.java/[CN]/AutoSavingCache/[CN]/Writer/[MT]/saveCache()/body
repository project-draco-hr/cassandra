{
  logger.debug("Deleting old {} files.",cacheType);
  deleteOldCacheFiles();
  if (keys.isEmpty()) {
    logger.debug("Skipping {} save, cache is empty.",cacheType);
    return;
  }
  long start=System.nanoTime();
  DataOutputStreamPlus writer=null;
  File tempCacheFile=tempCacheFile();
  try {
    try {
      writer=new DataOutputStreamPlus(streamFactory.getOutputStream(tempCacheFile));
    }
 catch (    FileNotFoundException e) {
      throw new RuntimeException(e);
    }
    for (    K key : keys) {
      ColumnFamilyStore cfs=Schema.instance.getColumnFamilyStoreIncludingIndexes(key.ksAndCFName);
      if (cfs == null)       continue;
      try {
        cacheLoader.serialize(key,writer,cfs);
      }
 catch (      IOException e) {
        throw new FSWriteError(e,tempCacheFile);
      }
      keysWritten++;
    }
  }
  finally {
    if (writer != null)     FileUtils.closeQuietly(writer);
  }
  File cacheFile=getCachePath(CURRENT_VERSION);
  cacheFile.delete();
  if (!tempCacheFile.renameTo(cacheFile))   logger.error("Unable to rename {} to {}",tempCacheFile,cacheFile);
  logger.info("Saved {} ({} items) in {} ms",cacheType,keys.size(),TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start));
}
