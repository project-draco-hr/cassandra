{
  outputHandler.output("Upgrading " + sstable);
  Set<SSTableReader> toUpgrade=Sets.newHashSet(sstable);
  SSTableRewriter writer=new SSTableRewriter(cfs,toUpgrade,CompactionTask.getMaxDataAge(toUpgrade),true);
  try (AbstractCompactionStrategy.ScannerList scanners=strategy.getScanners(toUpgrade)){
    Iterator<AbstractCompactedRow> iter=new CompactionIterable(compactionType,scanners.scanners,controller).iterator();
    writer.switchWriter(createCompactionWriter(sstable.getSSTableMetadata().repairedAt));
    while (iter.hasNext()) {
      AbstractCompactedRow row=iter.next();
      writer.append(row);
    }
    List<SSTableReader> sstables=writer.finish();
    cfs.getDataTracker().markCompactedSSTablesReplaced(toUpgrade,sstables,OperationType.UPGRADE_SSTABLES);
    outputHandler.output("Upgrade of " + sstable + " complete.");
  }
 catch (  Throwable t) {
    writer.abort();
    throw Throwables.propagate(t);
  }
 finally {
    controller.close();
  }
}
