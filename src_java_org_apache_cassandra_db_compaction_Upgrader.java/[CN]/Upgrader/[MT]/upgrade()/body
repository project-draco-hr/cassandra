{
  outputHandler.output("Upgrading " + sstable);
  try (SSTableRewriter writer=new SSTableRewriter(cfs,transaction,CompactionTask.getMaxDataAge(transaction.originals()),true);AbstractCompactionStrategy.ScannerList scanners=strategy.getScanners(transaction.originals())){
    Iterator<AbstractCompactedRow> iter=new CompactionIterable(compactionType,scanners.scanners,controller,DatabaseDescriptor.getSSTableFormat(),UUIDGen.getTimeUUID()).iterator();
    writer.switchWriter(createCompactionWriter(sstable.getSSTableMetadata().repairedAt));
    while (iter.hasNext()) {
      AbstractCompactedRow row=iter.next();
      writer.append(row);
    }
    writer.finish();
    outputHandler.output("Upgrade of " + sstable + " complete.");
  }
  finally {
    controller.close();
  }
}
