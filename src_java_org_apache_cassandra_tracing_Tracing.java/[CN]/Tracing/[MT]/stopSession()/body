{
  TraceState state=this.state.get();
  if (state == null) {
    logger.debug("request complete");
  }
 else {
    final int elapsed=state.elapsed();
    final ByteBuffer sessionIdBytes=state.sessionIdBytes;
    StageManager.getStage(Stage.TRACING).execute(new Runnable(){
      public void run(){
        Mutation mutation=new Mutation(TRACE_KS,sessionIdBytes);
        ColumnFamily cells=mutation.addOrGet(CFMetaData.TraceSessionsCf);
        CFRowAdder adder=new CFRowAdder(cells,cells.metadata().comparator.builder().build(),FBUtilities.timestampMicros());
        adder.add("duration",elapsed);
        mutateWithCatch(mutation);
      }
    }
);
    sessions.remove(state.sessionId);
    this.state.set(null);
  }
}
