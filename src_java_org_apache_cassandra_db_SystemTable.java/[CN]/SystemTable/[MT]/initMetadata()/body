{
  if (metadata != null)   return metadata;
  Table table=Table.open(Table.SYSTEM_TABLE);
  QueryFilter filter=new IdentityQueryFilter(LOCATION_KEY,new QueryPath(STATUS_CF));
  ColumnFamily cf=table.getColumnFamilyStore(STATUS_CF).getColumnFamily(filter);
  IPartitioner p=StorageService.getPartitioner();
  if (cf == null) {
    Token token;
    String initialToken=DatabaseDescriptor.getInitialToken();
    if (initialToken == null)     token=p.getRandomToken();
 else     token=p.getToken(initialToken);
    logger.info("Saved Token not found. Using " + token);
    int generation=(int)(System.currentTimeMillis() / 1000);
    RowMutation rm=new RowMutation(Table.SYSTEM_TABLE,LOCATION_KEY);
    cf=ColumnFamily.create(Table.SYSTEM_TABLE,SystemTable.STATUS_CF);
    cf.addColumn(new Column(TOKEN,p.getTokenFactory().toByteArray(token)));
    cf.addColumn(new Column(GENERATION,FBUtilities.toByteArray(generation)));
    rm.add(cf);
    rm.apply();
    metadata=new StorageMetadata(token,generation);
    return metadata;
  }
  IColumn tokenColumn=cf.getColumn(TOKEN);
  Token token=p.getTokenFactory().fromByteArray(tokenColumn.value());
  logger.info("Saved Token found: " + token);
  IColumn generation=cf.getColumn(GENERATION);
  int gen=Math.max(FBUtilities.byteArrayToInt(generation.value()) + 1,(int)(System.currentTimeMillis() / 1000));
  RowMutation rm=new RowMutation(Table.SYSTEM_TABLE,LOCATION_KEY);
  cf=ColumnFamily.create(Table.SYSTEM_TABLE,SystemTable.STATUS_CF);
  Column generation2=new Column(GENERATION,FBUtilities.toByteArray(gen),generation.timestamp() + 1);
  cf.addColumn(generation2);
  rm.add(cf);
  rm.apply();
  metadata=new StorageMetadata(token,gen);
  return metadata;
}
