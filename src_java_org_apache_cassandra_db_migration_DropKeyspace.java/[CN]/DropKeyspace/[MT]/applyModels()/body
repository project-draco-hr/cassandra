{
  String snapshotName=Table.getTimestampedSnapshotName(name);
  CompactionManager.instance.getCompactionLock().lock();
  try {
    KSMetaData ksm=schema.getTableDefinition(name);
    for (    CFMetaData cfm : ksm.cfMetaData().values()) {
      ColumnFamilyStore cfs=Table.open(ksm.name,schema).getColumnFamilyStore(cfm.cfName);
      schema.purge(cfm);
      if (!StorageService.instance.isClientMode()) {
        if (DatabaseDescriptor.isAutoSnapshot())         cfs.snapshot(snapshotName);
        cfs.flushLock.lock();
        try {
          Table.open(ksm.name,schema).dropCf(cfm.cfId);
        }
  finally {
          cfs.flushLock.unlock();
        }
      }
    }
    Table.clear(ksm.name,schema);
    schema.clearTableDefinition(ksm,newVersion);
  }
  finally {
    CompactionManager.instance.getCompactionLock().unlock();
  }
}
