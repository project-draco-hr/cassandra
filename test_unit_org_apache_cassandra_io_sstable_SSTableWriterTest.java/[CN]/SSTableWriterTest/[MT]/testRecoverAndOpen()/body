{
  RowMutation rm;
  rm=new RowMutation("Keyspace1",ByteBuffer.wrap("k1".getBytes()));
  rm.add(new QueryPath("Indexed1",null,ByteBuffer.wrap("birthdate".getBytes("UTF8"))),FBUtilities.toByteBuffer(1L),0);
  rm.apply();
  ColumnFamily cf=ColumnFamily.create("Keyspace1","Indexed1");
  cf.addColumn(new Column(ByteBuffer.wrap("birthdate".getBytes()),FBUtilities.toByteBuffer(1L),0));
  cf.addColumn(new Column(ByteBuffer.wrap("anydate".getBytes()),FBUtilities.toByteBuffer(1L),0));
  Map<ByteBuffer,ByteBuffer> entries=new HashMap<ByteBuffer,ByteBuffer>();
  DataOutputBuffer buffer=new DataOutputBuffer();
  ColumnFamily.serializer().serializeWithIndexes(cf,buffer);
  entries.put(ByteBuffer.wrap("k2".getBytes()),ByteBuffer.wrap(Arrays.copyOf(buffer.getData(),buffer.getLength())));
  cf.clear();
  cf.addColumn(new Column(ByteBuffer.wrap("anydate".getBytes()),FBUtilities.toByteBuffer(1L),0));
  buffer=new DataOutputBuffer();
  ColumnFamily.serializer().serializeWithIndexes(cf,buffer);
  entries.put(ByteBuffer.wrap("k3".getBytes()),ByteBuffer.wrap(Arrays.copyOf(buffer.getData(),buffer.getLength())));
  SSTableReader orig=SSTableUtils.writeRawSSTable("Keyspace1","Indexed1",entries);
  FileUtils.deleteWithConfirm(orig.descriptor.filenameFor(Component.PRIMARY_INDEX));
  FileUtils.deleteWithConfirm(orig.descriptor.filenameFor(Component.FILTER));
  SSTableReader sstr=CompactionManager.instance.submitSSTableBuild(orig.descriptor).get();
  ColumnFamilyStore cfs=Table.open("Keyspace1").getColumnFamilyStore("Indexed1");
  cfs.addSSTable(sstr);
  cfs.buildSecondaryIndexes(cfs.getSSTables(),cfs.getIndexedColumns());
  IndexExpression expr=new IndexExpression(ByteBuffer.wrap("birthdate".getBytes("UTF8")),IndexOperator.EQ,FBUtilities.toByteBuffer(1L));
  IndexClause clause=new IndexClause(Arrays.asList(expr),FBUtilities.EMPTY_BYTE_BUFFER,100);
  IFilter filter=new IdentityQueryFilter();
  IPartitioner p=StorageService.getPartitioner();
  Range range=new Range(p.getMinimumToken(),p.getMinimumToken());
  List<Row> rows=cfs.scan(clause,range,filter);
  assertEquals("IndexExpression should return two rows on recoverAndOpen",2,rows.size());
  assertTrue("First result should be 'k1'",ByteBuffer.wrap("k1".getBytes()).equals(rows.get(0).key.key));
}
