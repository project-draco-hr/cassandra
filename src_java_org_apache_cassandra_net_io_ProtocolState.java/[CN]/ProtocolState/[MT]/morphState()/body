{
  byte[] protocol=buffer_.array();
  if (MessagingService.isProtocolValid(protocol)) {
    StartState nextState=stream_.getSocketState(TcpReader.TcpReaderState.PROTOCOL);
    if (nextState == null) {
      nextState=new ProtocolHeaderState(stream_);
      stream_.putSocketState(TcpReader.TcpReaderState.PROTOCOL,nextState);
    }
    stream_.morphState(nextState);
    buffer_.clear();
  }
 else {
    throw new IOException("Invalid protocol header. The preamble seems to be messed up.");
  }
}
