{
  if (opcode >= opcodeIdx.length)   throw new ProtocolException(String.format("Unknown opcode %d",opcode));
  Type t=opcodeIdx[opcode];
  if (t == null)   throw new ProtocolException(String.format("Unknown opcode %d",opcode));
  if (t.direction != direction)   throw new ProtocolException(String.format("Wrong protocol direction (expected %s, got %s) for opcode %d (%s)",t.direction,direction,opcode,t));
  return t;
}
