{
  if (ctx.getChannel().isOpen()) {
    ChannelFuture future=ctx.getChannel().write(ErrorMessage.fromException(e.getCause()));
    if (e.getCause() instanceof ProtocolException) {
      future.addListener(new ChannelFutureListener(){
        public void operationComplete(        ChannelFuture future){
          ctx.getChannel().close();
        }
      }
);
    }
  }
}
