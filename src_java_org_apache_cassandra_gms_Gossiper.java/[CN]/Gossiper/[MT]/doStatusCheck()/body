{
  long now=System.currentTimeMillis();
  Set<InetAddress> eps=endpointStateMap_.keySet();
  for (  InetAddress endpoint : eps) {
    if (endpoint.equals(localEndpoint_))     continue;
    FailureDetector.instance.interpret(endpoint);
    EndpointState epState=endpointStateMap_.get(endpoint);
    if (epState != null) {
      long duration=now - epState.getUpdateTimestamp();
      if (!epState.getHasToken() && !epState.isAlive() && (duration > FatClientTimeout_)) {
        if (StorageService.instance.getTokenMetadata().isMember(endpoint))         epState.setHasToken(true);
 else {
          if (!justRemovedEndpoints_.containsKey(endpoint)) {
            logger_.info("FatClient " + endpoint + " has been silent for "+ FatClientTimeout_+ "ms, removing from gossip");
            removeEndpoint(endpoint);
          }
        }
      }
      if (!epState.isAlive() && (duration > aVeryLongTime_)) {
        evictFromMembership(endpoint);
      }
    }
  }
  if (!justRemovedEndpoints_.isEmpty()) {
    Map<InetAddress,Long> copy=new HashMap<InetAddress,Long>(justRemovedEndpoints_);
    for (    Map.Entry<InetAddress,Long> entry : copy.entrySet()) {
      if ((now - entry.getValue()) > QUARANTINE_DELAY) {
        if (logger_.isDebugEnabled())         logger_.debug(QUARANTINE_DELAY + " elapsed, " + entry.getKey()+ " gossip quarantine over");
        justRemovedEndpoints_.remove(entry.getKey());
      }
    }
  }
}
