{
  try (OpOrder.Group opGroup=writeOrder.start()){
    final ReplayPosition replayPosition;
    if (writeCommitLog) {
      Tracing.trace("Appending to commitlog");
      replayPosition=CommitLog.instance.add(mutation);
    }
 else {
      replayPosition=CommitLog.instance.getContext();
    }
    DecoratedKey key=StorageService.getPartitioner().decorateKey(mutation.key());
    for (    ColumnFamily cf : mutation.getColumnFamilies()) {
      ColumnFamilyStore cfs=columnFamilyStores.get(cf.id());
      if (cfs == null) {
        logger.error("Attempting to mutate non-existant column family {}",cf.id());
        continue;
      }
      Tracing.trace("Adding to {} memtable",cf.metadata().cfName);
      SecondaryIndexManager.Updater updater=updateIndexes ? cfs.indexManager.updaterFor(key,opGroup) : SecondaryIndexManager.nullUpdater;
      cfs.apply(key,cf,updater,opGroup,replayPosition);
    }
  }
 }
