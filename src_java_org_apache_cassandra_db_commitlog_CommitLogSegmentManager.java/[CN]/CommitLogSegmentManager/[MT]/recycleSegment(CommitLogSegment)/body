{
  boolean archiveSuccess=CommitLog.instance.archiver.maybeWaitForArchiving(segment.getName());
  if (!activeSegments.remove(segment)) {
    logger.warn("segment {} not found in activeSegments queue",segment);
    return;
  }
  if (!archiveSuccess) {
    discardSegment(segment,false);
    return;
  }
  if (isCapExceeded() || !DatabaseDescriptor.getCommitLogSegmentRecyclingEnabled()) {
    discardSegment(segment,true);
    return;
  }
  logger.debug("Recycling {}",segment);
  segmentManagementTasks.add(new Callable<CommitLogSegment>(){
    public CommitLogSegment call(){
      return segment.recycle();
    }
  }
);
}
