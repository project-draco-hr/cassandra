{
  Set<String> keyspaces=new HashSet<>(mutations.size());
  for (  Mutation mutation : mutations)   keyspaces.add(ByteBufferUtil.string(mutation.key()));
  Map<DecoratedKey,ColumnFamily> oldKeyspaces=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_KEYSPACES_CF,keyspaces);
  Map<DecoratedKey,ColumnFamily> oldColumnFamilies=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_COLUMNFAMILIES_CF,keyspaces);
  Map<DecoratedKey,ColumnFamily> oldTypes=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_USER_TYPES_CF,keyspaces);
  Map<DecoratedKey,ColumnFamily> oldFunctions=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_FUNCTIONS_CF);
  for (  Mutation mutation : mutations)   mutation.apply();
  if (doFlush && !StorageService.instance.isClientMode())   flushSchemaCFs();
  Map<DecoratedKey,ColumnFamily> newKeyspaces=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_KEYSPACES_CF,keyspaces);
  Map<DecoratedKey,ColumnFamily> newColumnFamilies=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_COLUMNFAMILIES_CF,keyspaces);
  Map<DecoratedKey,ColumnFamily> newTypes=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_USER_TYPES_CF,keyspaces);
  Map<DecoratedKey,ColumnFamily> newFunctions=SystemKeyspace.getSchema(SystemKeyspace.SCHEMA_FUNCTIONS_CF);
  Set<String> keyspacesToDrop=mergeKeyspaces(oldKeyspaces,newKeyspaces);
  mergeColumnFamilies(oldColumnFamilies,newColumnFamilies);
  mergeTypes(oldTypes,newTypes);
  mergeFunctions(oldFunctions,newFunctions);
  for (  String keyspaceToDrop : keyspacesToDrop)   dropKeyspace(keyspaceToDrop);
}
