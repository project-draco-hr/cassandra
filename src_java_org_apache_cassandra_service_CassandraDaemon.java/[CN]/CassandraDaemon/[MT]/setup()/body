{
  String file=System.getProperty("storage-config") + File.separator + "log4j.properties";
  PropertyConfigurator.configure(file);
  int listenPort=DatabaseDescriptor.getThriftPort();
  InetAddress listenAddr=DatabaseDescriptor.getThriftAddress();
  if (listenAddr == null)   listenAddr=FBUtilities.getLocalAddress();
  Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler(){
    public void uncaughtException(    Thread t,    Throwable e){
      logger.error("Fatal exception in thread " + t,e);
      if (e instanceof OutOfMemoryError) {
        System.exit(100);
      }
    }
  }
);
  for (  String table : Table.getAllTableNames()) {
    if (logger.isDebugEnabled())     logger.debug("opening keyspace " + table);
    Table tbl=Table.open(table);
    tbl.onStart();
  }
  RecoveryManager.doRecovery();
  CassandraServer cassandraServer=new CassandraServer();
  StorageService.instance().initServer();
  Cassandra.Processor processor=new Cassandra.Processor(cassandraServer);
  TServerSocket tServerSocket=new TServerSocket(new InetSocketAddress(listenAddr,listenPort));
  if (logger.isDebugEnabled())   logger.debug(String.format("Binding thrift service to %s:%s",listenAddr,listenPort));
  TProtocolFactory tProtocolFactory=new TBinaryProtocol.Factory();
  TTransportFactory inTransportFactory, outTransportFactory;
  if (DatabaseDescriptor.isThriftFramed()) {
    inTransportFactory=new TFramedTransport.Factory();
    outTransportFactory=new TFramedTransport.Factory();
  }
 else {
    inTransportFactory=new TTransportFactory();
    outTransportFactory=new TTransportFactory();
  }
  TThreadPoolServer.Options options=new TThreadPoolServer.Options();
  options.minWorkerThreads=64;
  serverEngine=new TThreadPoolServer(new TProcessorFactory(processor),tServerSocket,inTransportFactory,outTransportFactory,tProtocolFactory,tProtocolFactory,options);
}
