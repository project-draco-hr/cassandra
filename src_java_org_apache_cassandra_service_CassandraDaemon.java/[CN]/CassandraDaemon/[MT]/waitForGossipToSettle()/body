{
  int forceAfter=Integer.getInteger("cassandra.skip_wait_for_gossip_to_settle",-1);
  if (forceAfter == 0) {
    return;
  }
  final int GOSSIP_SETTLE_MIN_WAIT_MS=5000;
  final int GOSSIP_SETTLE_POLL_INTERVAL_MS=1000;
  final int GOSSIP_SETTLE_POLL_SUCCESSES_REQUIRED=3;
  logger.info("Waiting for gossip to settle before accepting client requests...");
  Uninterruptibles.sleepUninterruptibly(GOSSIP_SETTLE_MIN_WAIT_MS,TimeUnit.MILLISECONDS);
  int totalPolls=0;
  int numOkay=0;
  JMXEnabledThreadPoolExecutor gossipStage=(JMXEnabledThreadPoolExecutor)StageManager.getStage(Stage.GOSSIP);
  while (numOkay < GOSSIP_SETTLE_POLL_SUCCESSES_REQUIRED) {
    Uninterruptibles.sleepUninterruptibly(GOSSIP_SETTLE_POLL_INTERVAL_MS,TimeUnit.MILLISECONDS);
    long completed=gossipStage.metrics.completedTasks.getValue();
    long active=gossipStage.metrics.activeTasks.getValue();
    long pending=gossipStage.metrics.pendingTasks.getValue();
    totalPolls++;
    if (active == 0 && pending == 0) {
      logger.debug("Gossip looks settled. CompletedTasks: {}",completed);
      numOkay++;
    }
 else {
      logger.info("Gossip not settled after {} polls. Gossip Stage active/pending/completed: {}/{}/{}",totalPolls,active,pending,completed);
      numOkay=0;
    }
    if (forceAfter > 0 && totalPolls > forceAfter) {
      logger.warn("Gossip not settled but startup forced by cassandra.skip_wait_for_gossip_to_settle. Gossip Stage total/active/pending/completed: {}/{}/{}/{}",totalPolls,active,pending,completed);
      break;
    }
  }
  if (totalPolls > GOSSIP_SETTLE_POLL_SUCCESSES_REQUIRED)   logger.info("Gossip settled after {} extra polls; proceeding",totalPolls - GOSSIP_SETTLE_POLL_SUCCESSES_REQUIRED);
 else   logger.info("No gossip backlog; proceeding");
}
