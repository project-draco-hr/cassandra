{
  int startIndex;
  ArrayList<InetAddress> endpoints=new ArrayList<InetAddress>();
  boolean bDataCenter=false;
  boolean bOtherRack=false;
  int foundCount=0;
  List tokens=new ArrayList(tokenToEndPointMap.keySet());
  Collections.sort(tokens);
  int index=Collections.binarySearch(tokens,token);
  if (index < 0) {
    index=(index + 1) * (-1);
    if (index >= tokens.size())     index=0;
  }
  int totalNodes=tokens.size();
  endpoints.add(tokenToEndPointMap.get(tokens.get(index)));
  foundCount++;
  if (replicas_ == 1) {
    return endpoints;
  }
  startIndex=(index + 1) % totalNodes;
  IEndPointSnitch endPointSnitch=StorageService.instance().getEndPointSnitch();
  for (int i=startIndex, count=1; count < totalNodes && foundCount < replicas_; ++count, i=(i + 1) % totalNodes) {
    try {
      if (!endPointSnitch.isInSameDataCenter(tokenToEndPointMap.get(tokens.get(index)),tokenToEndPointMap.get(tokens.get(i)))) {
        if (!bDataCenter) {
          endpoints.add(tokenToEndPointMap.get(tokens.get(i)));
          bDataCenter=true;
          foundCount++;
        }
        continue;
      }
      if (!endPointSnitch.isOnSameRack(tokenToEndPointMap.get(tokens.get(index)),tokenToEndPointMap.get(tokens.get(i))) && endPointSnitch.isInSameDataCenter(tokenToEndPointMap.get(tokens.get(index)),tokenToEndPointMap.get(tokens.get(i)))) {
        if (!bOtherRack) {
          endpoints.add(tokenToEndPointMap.get(tokens.get(i)));
          bOtherRack=true;
          foundCount++;
        }
      }
    }
 catch (    UnknownHostException e) {
      if (logger_.isDebugEnabled())       logger_.debug(LogUtil.throwableToString(e));
    }
  }
  for (int i=startIndex, count=1; count < totalNodes && foundCount < replicas_; ++count, i=(i + 1) % totalNodes) {
    if (!endpoints.contains(tokenToEndPointMap.get(tokens.get(i)))) {
      endpoints.add(tokenToEndPointMap.get(tokens.get(i)));
      foundCount++;
    }
  }
  return endpoints;
}
