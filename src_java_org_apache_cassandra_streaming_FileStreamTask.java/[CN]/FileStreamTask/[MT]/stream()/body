{
  ByteBuffer HeaderBuffer=MessagingService.instance().constructStreamHeader(header,false,Gossiper.instance.getVersion(to));
  output.write(ByteBufferUtil.getArray(HeaderBuffer));
  if (header.file == null)   return;
  RandomAccessReader file=(header.file.sstable.compression) ? CompressedRandomAccessReader.open(header.file.getFilename(),header.file.sstable.getCompressionMetadata(),true) : RandomAccessReader.open(new File(header.file.getFilename()),true);
  compressedoutput=new LZFOutputStream(output);
  try {
    for (    Pair<Long,Long> section : header.file.sections) {
      file.seek(section.left);
      long length=section.right - section.left;
      long bytesTransferred=0;
      while (bytesTransferred < length) {
        long lastWrite=write(file,length,bytesTransferred);
        bytesTransferred+=lastWrite;
        header.file.progress+=lastWrite;
      }
      compressedoutput.flush();
      if (logger.isDebugEnabled())       logger.debug("Bytes transferred " + bytesTransferred + "/"+ header.file.size);
    }
    receiveReply();
  }
  finally {
    FileUtils.closeQuietly(file);
  }
}
