{
  if (!isReplaying.compareAndSet(false,true))   return;
  logger.debug("Started replayAllFailedBatches");
  try {
    for (    UntypedResultSet.Row row : process("SELECT id, written_at FROM %s.%s",Keyspace.SYSTEM_KS,SystemKeyspace.BATCHLOG_CF))     if (System.currentTimeMillis() > row.getLong("written_at") + TIMEOUT)     replayBatch(row.getUUID("id"));
    cleanup();
  }
  finally {
    isReplaying.set(false);
  }
  logger.debug("Finished replayAllFailedBatches");
}
