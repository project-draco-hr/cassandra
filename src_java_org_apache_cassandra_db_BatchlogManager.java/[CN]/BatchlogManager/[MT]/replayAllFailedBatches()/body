{
  logger.debug("Started replayAllFailedBatches");
  int throttleInKB=DatabaseDescriptor.getBatchlogReplayThrottleInKB() / StorageService.instance.getTokenMetadata().getAllEndpoints().size();
  RateLimiter rateLimiter=RateLimiter.create(throttleInKB == 0 ? Double.MAX_VALUE : throttleInKB * 1024);
  UUID limitUuid=UUIDGen.maxTimeUUID(System.currentTimeMillis() - getBatchlogTimeout());
  int pageSize=calculatePageSize();
  String query=String.format("SELECT id, data, version FROM %s.%s WHERE token(id) > token(?) AND token(id) <= token(?)",SystemKeyspace.NAME,SystemKeyspace.BATCHES);
  UntypedResultSet batches=executeInternalWithPaging(query,pageSize,lastReplayedUuid,limitUuid);
  processBatchlogEntries(batches,pageSize,rateLimiter);
  lastReplayedUuid=limitUuid;
  logger.debug("Finished replayAllFailedBatches");
}
