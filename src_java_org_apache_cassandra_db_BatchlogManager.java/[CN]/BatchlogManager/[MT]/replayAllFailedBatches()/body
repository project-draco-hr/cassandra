{
  if (!isReplaying.compareAndSet(false,true))   return;
  logger.debug("Started replayAllFailedBatches");
  int throttleInKB=DatabaseDescriptor.getBatchlogReplayThrottleInKB() / StorageService.instance.getTokenMetadata().getAllEndpoints().size();
  RateLimiter rateLimiter=RateLimiter.create(throttleInKB == 0 ? Double.MAX_VALUE : throttleInKB * 1024);
  try {
    for (    UntypedResultSet.Row row : process("SELECT id, written_at FROM %s.%s",Table.SYSTEM_KS,SystemTable.BATCHLOG_CF))     if (System.currentTimeMillis() > row.getLong("written_at") + TIMEOUT)     replayBatch(row.getUUID("id"),rateLimiter);
    cleanup();
  }
  finally {
    isReplaying.set(false);
  }
  logger.debug("Finished replayAllFailedBatches");
}
