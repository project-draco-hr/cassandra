{
  DiskFailurePolicy origPolicy=DatabaseDescriptor.getDiskFailurePolicy();
  try {
    DatabaseDescriptor.setDiskFailurePolicy(DiskFailurePolicy.best_effort);
    if (Directories.dataFileLocations.length > 0) {
      String[] path=new String[]{KS,"bad"};
      File dir=new File(Directories.dataFileLocations[0].location,StringUtils.join(path,File.separator));
      FileUtils.handleFSError(new FSWriteError(new IOException("Unable to create directory " + dir),dir));
    }
    for (    DataDirectory dd : Directories.dataFileLocations) {
      File file=new File(dd.location,new File(KS,"bad").getPath());
      Assert.assertTrue(BlacklistedDirectories.isUnwritable(file));
    }
  }
  finally {
    DatabaseDescriptor.setDiskFailurePolicy(origPolicy);
  }
}
