{
  System.out.format("\nTesting commit log size %.0fmb, compressor: %s, encryption enabled: %b, sync %s%s%s\n",mb(DatabaseDescriptor.getCommitLogSegmentSize()),commitLog.configuration.getCompressorName(),commitLog.configuration.useEncryption(),commitLog.executor.getClass().getSimpleName(),randomSize ? " random size" : "",discardedRun ? " with discarded run" : "");
  commitLog.allocator.enableReserveSegmentCreation();
  final List<CommitlogThread> threads=new ArrayList<>();
  ScheduledExecutorService scheduled=startThreads(commitLog,threads);
  discardedPos=ReplayPosition.NONE;
  if (discardedRun) {
    Thread.sleep(runTimeMs / 3);
    stop=true;
    scheduled.shutdown();
    scheduled.awaitTermination(2,TimeUnit.SECONDS);
    for (    CommitlogThread t : threads) {
      t.join();
      if (t.rp.compareTo(discardedPos) > 0)       discardedPos=t.rp;
    }
    verifySizes(commitLog);
    commitLog.discardCompletedSegments(Schema.instance.getCFMetaData("Keyspace1","Standard1").cfId,discardedPos);
    threads.clear();
    System.out.format("Discarded at %s\n",discardedPos);
    verifySizes(commitLog);
    scheduled=startThreads(commitLog,threads);
  }
  Thread.sleep(runTimeMs);
  stop=true;
  scheduled.shutdown();
  scheduled.awaitTermination(2,TimeUnit.SECONDS);
  int hash=0;
  int cells=0;
  for (  CommitlogThread t : threads) {
    t.join();
    hash+=t.hash;
    cells+=t.cells;
  }
  verifySizes(commitLog);
  commitLog.shutdownBlocking();
  System.out.println("Stopped. Replaying... ");
  System.out.flush();
  Replayer repl=new Replayer(commitLog);
  File[] files=new File(location).listFiles();
  repl.recover(files);
  for (  File f : files)   if (!f.delete())   Assert.fail("Failed to delete " + f);
  if (hash == repl.hash && cells == repl.cells)   System.out.format("Test success. compressor = %s, encryption enabled = %b; discarded = %d, skipped = %d\n",commitLog.configuration.getCompressorName(),commitLog.configuration.useEncryption(),repl.discarded,repl.skipped);
 else {
    System.out.format("Test failed (compressor = %s, encryption enabled = %b). Cells %d, expected %d, diff %d; discarded = %d, skipped = %d -  hash %d expected %d.\n",commitLog.configuration.getCompressorName(),commitLog.configuration.useEncryption(),repl.cells,cells,cells - repl.cells,repl.discarded,repl.skipped,repl.hash,hash);
    failed=true;
  }
}
