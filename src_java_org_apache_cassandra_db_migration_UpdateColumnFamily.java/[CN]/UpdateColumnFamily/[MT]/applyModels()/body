{
  acquireLocks();
  try {
    logger.debug("Updating " + oldCfm + " to "+ newCfm);
    KSMetaData newKsm=makeNewKeyspaceDefinition(DatabaseDescriptor.getTableDefinition(newCfm.tableName));
    DatabaseDescriptor.setTableDefinition(newKsm,newVersion);
    if (!clientMode) {
      Table table=Table.open(oldCfm.tableName);
      ColumnFamilyStore oldCfs=table.getColumnFamilyStore(oldCfm.cfName);
      table.reloadCf(newCfm.cfId);
      for (      Map.Entry<ByteBuffer,ColumnDefinition> entry : oldCfm.getColumn_metadata().entrySet()) {
        ByteBuffer column=entry.getKey();
        ColumnDefinition def=entry.getValue();
        if (def.index_type != null && (!newCfm.getColumn_metadata().containsKey(column) || newCfm.getColumn_metadata().get(column).index_type == null)) {
          ColumnFamilyStore indexCfs=oldCfs.getIndexedColumnFamilyStore(column);
          SystemTable.setIndexRemoved(table.name,indexCfs.columnFamily);
          indexCfs.removeAllSSTables();
        }
      }
    }
  }
  finally {
    releaseLocks();
  }
}
