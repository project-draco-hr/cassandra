{
  Keyspace ks=Keyspace.open(KEYSPACE);
  ColumnFamilyStore cfs=ks.getColumnFamilyStore(TABLE);
  int rowCount=1000;
  cfs.disableAutoCompaction();
  populate(rowCount);
  LifecycleTransaction txn=cfs.getTracker().tryModify(cfs.getSSTables(),OperationType.COMPACTION);
  long beforeSize=txn.originals().iterator().next().onDiskLength();
  CompactionAwareWriter writer=new DefaultCompactionWriter(cfs,txn,txn.originals(),false);
  int rows=compact(cfs,txn,writer);
  assertEquals(1,cfs.getSSTables().size());
  assertEquals(rowCount,rows);
  assertEquals(beforeSize,cfs.getSSTables().iterator().next().onDiskLength());
  validateData(cfs,rowCount);
  cfs.truncateBlocking();
}
