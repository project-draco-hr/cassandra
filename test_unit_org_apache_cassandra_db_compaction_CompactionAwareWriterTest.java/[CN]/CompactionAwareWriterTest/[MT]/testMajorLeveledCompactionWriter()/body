{
  Keyspace ks=Keyspace.open(KEYSPACE1);
  ColumnFamilyStore cfs=ks.getColumnFamilyStore(CF);
  cfs.disableAutoCompaction();
  int rowCount=20000;
  int targetSSTableCount=50;
  populate(cfs,rowCount);
  Set<SSTableReader> sstables=new HashSet<>(cfs.getSSTables());
  long beforeSize=sstables.iterator().next().onDiskLength();
  int sstableSize=(int)beforeSize / targetSSTableCount;
  CompactionAwareWriter writer=new MajorLeveledCompactionWriter(cfs,sstables,sstables,sstableSize,false,OperationType.COMPACTION);
  int rows=compact(cfs,sstables,writer);
  assertEquals(targetSSTableCount,cfs.getSSTables().size());
  int[] levelCounts=new int[5];
  assertEquals(rowCount,rows);
  for (  SSTableReader sstable : cfs.getSSTables()) {
    levelCounts[sstable.getSSTableLevel()]++;
  }
  assertEquals(0,levelCounts[0]);
  assertEquals(10,levelCounts[1]);
  assertEquals(targetSSTableCount - 10,levelCounts[2]);
  for (int i=3; i < levelCounts.length; i++)   assertEquals(0,levelCounts[i]);
  validateData(cfs,rowCount);
  cfs.truncateBlocking();
}
