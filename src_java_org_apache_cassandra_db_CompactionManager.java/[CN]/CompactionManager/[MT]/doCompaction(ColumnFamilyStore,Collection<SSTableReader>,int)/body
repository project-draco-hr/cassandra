{
  Table table=cfs.table;
  if (DatabaseDescriptor.isSnapshotBeforeCompaction())   table.snapshot("compact-" + cfs.columnFamily);
  logger.info("Compacting [" + StringUtils.join(sstables,",") + "]");
  String compactionFileLocation=table.getDataFileLocation(cfs.getExpectedCompactedFileSize(sstables));
  List<SSTableReader> smallerSSTables=new ArrayList<SSTableReader>(sstables);
  while (compactionFileLocation == null && smallerSSTables.size() > 1) {
    logger.warn("insufficient space to compact all requested files " + StringUtils.join(smallerSSTables,", "));
    smallerSSTables.remove(cfs.getMaxSizeFile(smallerSSTables));
    compactionFileLocation=table.getDataFileLocation(cfs.getExpectedCompactedFileSize(smallerSSTables));
  }
  if (compactionFileLocation == null) {
    logger.error("insufficient space to compact even the two smallest files, aborting");
    return 0;
  }
  sstables=smallerSSTables;
  boolean major=cfs.isCompleteSSTables(sstables);
  long startTime=System.currentTimeMillis();
  long totalkeysWritten=0;
  int expectedBloomFilterSize=Math.max(DatabaseDescriptor.getIndexInterval(),(int)SSTableReader.getApproximateKeyCount(sstables));
  if (logger.isDebugEnabled())   logger.debug("Expected bloom filter size : " + expectedBloomFilterSize);
  SSTableWriter writer;
  CompactionIterator ci=new CompactionIterator(cfs,sstables,gcBefore,major);
  Iterator<AbstractCompactedRow> nni=new FilterIterator(ci,PredicateUtils.notNullPredicate());
  executor.beginCompaction(cfs,ci);
  try {
    if (!nni.hasNext()) {
      cfs.markCompacted(sstables);
      return 0;
    }
    String newFilename=new File(cfs.getTempSSTablePath(compactionFileLocation)).getAbsolutePath();
    writer=new SSTableWriter(newFilename,expectedBloomFilterSize,cfs.metadata,cfs.partitioner);
    while (nni.hasNext()) {
      AbstractCompactedRow row=nni.next();
      long prevpos=writer.getFilePointer();
      writer.append(row);
      totalkeysWritten++;
    }
  }
  finally {
    ci.close();
  }
  SSTableReader ssTable=writer.closeAndOpenReader(getMaxDataAge(sstables));
  cfs.replaceCompactedSSTables(sstables,Arrays.asList(ssTable));
  submitMinorIfNeeded(cfs);
  String format="Compacted to %s.  %,d to %,d (~%d%% of original) bytes for %,d keys.  Time: %,dms.";
  long dTime=System.currentTimeMillis() - startTime;
  long startsize=SSTable.getTotalBytes(sstables);
  long endsize=ssTable.length();
  double ratio=(double)endsize / (double)startsize;
  logger.info(String.format(format,writer.getFilename(),startsize,endsize,(int)(ratio * 100),totalkeysWritten,dTime));
  return sstables.size();
}
