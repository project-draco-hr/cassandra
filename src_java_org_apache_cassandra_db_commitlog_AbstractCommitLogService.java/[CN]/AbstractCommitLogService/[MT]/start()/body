{
  if (pollIntervalMillis < 1)   throw new IllegalArgumentException(String.format("Commit log flush interval must be positive: %dms",pollIntervalMillis));
  Runnable runnable=new Runnable(){
    public void run(){
      long firstLagAt=0;
      long totalSyncDuration=0;
      long syncExceededIntervalBy=0;
      int lagCount=0;
      int syncCount=0;
      boolean run=true;
      while (run) {
        try {
          run=!shutdown;
          long syncStarted=System.currentTimeMillis();
          commitLog.sync(shutdown);
          lastSyncedAt=syncStarted;
          syncComplete.signalAll();
          long now=System.currentTimeMillis();
          long sleep=syncStarted + pollIntervalMillis - now;
          if (sleep < 0) {
            if (firstLagAt == 0) {
              firstLagAt=now;
              totalSyncDuration=syncExceededIntervalBy=syncCount=lagCount=0;
            }
            syncExceededIntervalBy-=sleep;
            lagCount++;
          }
          syncCount++;
          totalSyncDuration+=now - syncStarted;
          if (firstLagAt > 0) {
            boolean logged=NoSpamLogger.log(logger,NoSpamLogger.Level.WARN,5,TimeUnit.MINUTES,"Out of {} commit log syncs over the past {}s with average duration of {}ms, {} have exceeded the configured commit interval by an average of {}ms",syncCount,(now - firstLagAt) / 1000,String.format("%.2f",(double)totalSyncDuration / syncCount),lagCount,String.format("%.2f",(double)syncExceededIntervalBy / lagCount));
            if (logged)             firstLagAt=0;
          }
          if (sleep < 0 || !run)           continue;
          try {
            haveWork.tryAcquire(sleep,TimeUnit.MILLISECONDS);
            haveWork.drainPermits();
          }
 catch (          InterruptedException e) {
            throw new AssertionError();
          }
        }
 catch (        Throwable t) {
          if (!CommitLog.handleCommitError("Failed to persist commits to disk",t))           break;
          try {
            haveWork.tryAcquire(pollIntervalMillis,TimeUnit.MILLISECONDS);
          }
 catch (          InterruptedException e) {
            throw new AssertionError();
          }
        }
      }
    }
  }
;
  thread=new Thread(runnable,name);
  thread.start();
}
