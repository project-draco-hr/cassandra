{
  Set<Class<? extends SecondaryIndex>> appliedRowLevelIndexes=null;
  if (oldIndexedColumns != null) {
    for (    IColumn column : oldIndexedColumns) {
      if (column.isMarkedForDelete())       continue;
      SecondaryIndex index=getIndexForFullColumnName(column.name());
      if (index == null) {
        logger.debug("Looks like index got dropped mid-update.  Skipping");
        continue;
      }
      if (index instanceof PerRowSecondaryIndex) {
        if (appliedRowLevelIndexes == null)         appliedRowLevelIndexes=new HashSet<Class<? extends SecondaryIndex>>();
        if (appliedRowLevelIndexes.add(index.getClass()))         ((PerRowSecondaryIndex)index).applyIndexUpdates(rowKey,cf,mutatedIndexedColumns,oldIndexedColumns);
      }
 else {
        DecoratedKey valueKey=index.getIndexKeyFor(column.value());
        ((PerColumnSecondaryIndex)index).deleteColumn(valueKey,rowKey,column);
      }
    }
  }
  for (  ByteBuffer columnName : mutatedIndexedColumns) {
    IColumn column=cf.getColumn(columnName);
    if (column == null || column.isMarkedForDelete())     continue;
    SecondaryIndex index=getIndexForFullColumnName(columnName);
    if (index == null) {
      logger.debug("index on {} removed; skipping remove-old for {}",columnName,ByteBufferUtil.bytesToHex(rowKey));
      continue;
    }
    if (index instanceof PerRowSecondaryIndex) {
      if (appliedRowLevelIndexes == null)       appliedRowLevelIndexes=new HashSet<Class<? extends SecondaryIndex>>();
      if (appliedRowLevelIndexes.add(index.getClass()))       ((PerRowSecondaryIndex)index).applyIndexUpdates(rowKey,cf,mutatedIndexedColumns,oldIndexedColumns);
    }
 else {
      DecoratedKey valueKey=index.getIndexKeyFor(column.value());
      ((PerColumnSecondaryIndex)index).insertColumn(valueKey,rowKey,column);
    }
  }
}
