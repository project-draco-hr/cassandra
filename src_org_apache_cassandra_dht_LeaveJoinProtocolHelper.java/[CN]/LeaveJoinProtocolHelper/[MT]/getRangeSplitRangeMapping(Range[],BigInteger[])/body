{
  Map<Range,List<Range>> splitRanges=new HashMap<Range,List<Range>>();
  BigInteger[] tokens=new BigInteger[allTokens.length];
  System.arraycopy(allTokens,0,tokens,0,tokens.length);
  Arrays.sort(tokens);
  Range prevRange=null;
  BigInteger prevToken=null;
  boolean bVal=false;
  for (  Range oldRange : oldRanges) {
    if (bVal && prevRange != null) {
      bVal=false;
      List<Range> subRanges=splitRanges.get(prevRange);
      if (subRanges != null)       subRanges.add(new Range(prevToken,prevRange.right()));
    }
    prevRange=oldRange;
    prevToken=oldRange.left();
    for (    BigInteger token : tokens) {
      List<Range> subRanges=splitRanges.get(oldRange);
      if (oldRange.contains(token)) {
        if (subRanges == null) {
          subRanges=new ArrayList<Range>();
          splitRanges.put(oldRange,subRanges);
        }
        subRanges.add(new Range(prevToken,token));
        prevToken=token;
        bVal=true;
      }
 else {
        if (bVal) {
          bVal=false;
          subRanges.add(new Range(prevToken,oldRange.right()));
        }
      }
    }
  }
  if (bVal) {
    bVal=false;
    List<Range> subRanges=splitRanges.get(prevRange);
    subRanges.add(new Range(prevToken,prevRange.right()));
  }
  return splitRanges;
}
