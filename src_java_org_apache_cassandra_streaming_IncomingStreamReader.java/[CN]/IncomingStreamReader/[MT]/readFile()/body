{
  if (logger.isDebugEnabled()) {
    logger.debug("Receiving stream");
    logger.debug("Creating file for {}",localFile.getFilename());
  }
  FileOutputStream fos=new FileOutputStream(localFile.getFilename(),true);
  FileChannel fc=fos.getChannel();
  long offset=0;
  try {
    for (    Pair<Long,Long> section : localFile.sections) {
      long length=section.right - section.left;
      long bytesRead=0;
      while (bytesRead < length) {
        bytesRead=readnwrite(length,bytesRead,offset,fc);
      }
      offset+=length;
    }
  }
 catch (  IOException ex) {
    session.retry(remoteFile);
    FileUtils.deleteWithConfirm(new File(localFile.getFilename()));
    throw ex;
  }
 finally {
    fc.close();
  }
  session.finished(remoteFile,localFile);
}
