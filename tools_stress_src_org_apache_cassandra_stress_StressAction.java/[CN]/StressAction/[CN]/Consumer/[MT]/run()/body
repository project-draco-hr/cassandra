{
  try {
    SimpleClient sclient=null;
    ThriftClient tclient=null;
    JavaDriverClient jclient=null;
switch (settings.mode.api) {
case JAVA_DRIVER_NATIVE:
      jclient=settings.getJavaDriverClient();
    break;
case SIMPLE_NATIVE:
  sclient=settings.getSimpleNativeClient();
break;
case THRIFT:
tclient=settings.getThriftClient();
break;
case THRIFT_SMART:
tclient=settings.getSmartThriftClient();
break;
default :
throw new IllegalStateException();
}
Work work;
while (null != (work=workQueue.poll())) {
if (rateLimiter != null) rateLimiter.acquire(work.count);
for (int i=0; i < work.count; i++) {
try {
Operation op=createOperation(state,i + work.offset);
switch (settings.mode.api) {
case JAVA_DRIVER_NATIVE:
op.run(jclient);
break;
case SIMPLE_NATIVE:
op.run(sclient);
break;
case THRIFT:
case THRIFT_SMART:
default :
op.run(tclient);
}
}
 catch (Exception e) {
if (output == null) {
System.err.println(e.getMessage());
success=false;
System.exit(-1);
}
e.printStackTrace(output);
success=false;
workQueue.stop();
state.metrics.cancel();
return;
}
}
}
}
  finally {
done.countDown();
state.timer.close();
}
}
