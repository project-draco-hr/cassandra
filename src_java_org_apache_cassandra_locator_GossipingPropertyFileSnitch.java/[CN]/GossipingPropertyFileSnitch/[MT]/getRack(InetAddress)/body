{
  if (endpoint.equals(FBUtilities.getBroadcastAddress()))   return myRack;
  EndpointState epState=Gossiper.instance.getEndpointStateForEndpoint(endpoint);
  if (epState == null || epState.getApplicationState(ApplicationState.RACK) == null) {
    if (psnitch == null) {
      if (savedEndpoints == null)       savedEndpoints=SystemTable.loadDcRackInfo();
      if (savedEndpoints.containsKey(endpoint))       return savedEndpoints.get(endpoint).get("rack");
      throw new RuntimeException("Could not retrieve rack for " + endpoint + " from gossip and PFS compatibility is disabled");
    }
 else     return psnitch.getRack(endpoint);
  }
  return epState.getApplicationState(ApplicationState.RACK).value;
}
