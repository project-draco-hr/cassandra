{
  ByteBuffer indexedColumnName=ByteBufferUtil.bytes("indexed");
  RowMutation rm;
  rm=new RowMutation("PerRowSecondaryIndex",ByteBufferUtil.bytes("k1"));
  rm.add("Indexed1",indexedColumnName,ByteBufferUtil.bytes("foo"),1);
  rm.apply();
  assertTrue(Arrays.equals("k1".getBytes(),PerRowSecondaryIndexTest.TestIndex.LAST_INDEXED_KEY.array()));
  ColumnFamilyStore cfs=Keyspace.open("PerRowSecondaryIndex").getColumnFamilyStore("Indexed1");
  cfs.forceBlockingFlush();
  PerRowSecondaryIndexTest.TestIndex.reset();
  ColumnFamilyStore.rebuildSecondaryIndex("PerRowSecondaryIndex","Indexed1",PerRowSecondaryIndexTest.TestIndex.class.getSimpleName());
  assertTrue(Arrays.equals("k1".getBytes(),PerRowSecondaryIndexTest.TestIndex.LAST_INDEXED_KEY.array()));
  PerRowSecondaryIndexTest.TestIndex.reset();
  ColumnDefinition indexedColumnDef=cfs.metadata.getColumnDefinition(indexedColumnName);
  cfs.indexManager.getIndexForColumn(indexedColumnName).getColumnDefs().remove(indexedColumnDef);
  ColumnFamilyStore.rebuildSecondaryIndex("PerRowSecondaryIndex","Indexed1",PerRowSecondaryIndexTest.TestIndex.class.getSimpleName());
  assertNull(PerRowSecondaryIndexTest.TestIndex.LAST_INDEXED_KEY);
  PerRowSecondaryIndexTest.TestIndex.reset();
}
