{
  try {
    connection.clientState().setCQLVersion(cqlVersion);
    if (connection.clientState().getCQLVersion().compareTo(new SemanticVersion("2.99.0")) < 0)     throw new ProtocolException(String.format("CQL version %s is not support by the binary protocol (supported version are >= 3.0.0)",cqlVersion));
    if (options.containsKey(Option.COMPRESSION)) {
      String compression=((String)options.get(Option.COMPRESSION)).toLowerCase();
      if (compression.equals("snappy")) {
        if (FrameCompressor.SnappyCompressor.instance == null)         throw new ProtocolException("This instance does not support Snappy compression");
        connection.setCompressor(FrameCompressor.SnappyCompressor.instance);
      }
 else {
        throw new ProtocolException(String.format("Unknown compression algorithm: %s",compression));
      }
    }
    if (connection.clientState().isLogged())     return new ReadyMessage();
 else     return new AuthenticateMessage(DatabaseDescriptor.getAuthenticator().getClass().getName());
  }
 catch (  InvalidRequestException e) {
    return ErrorMessage.fromException(new ProtocolException(e.getMessage()));
  }
}
