{
  String username=credentials.get(USERNAME_KEY);
  if (username == null)   throw new AuthenticationException(String.format("Required key '%s' is missing",USERNAME_KEY));
  String password=credentials.get(PASSWORD_KEY);
  if (password == null)   throw new AuthenticationException(String.format("Required key '%s' is missing",PASSWORD_KEY));
  UntypedResultSet result;
  try {
    ResultMessage.Rows rows=authenticateStatement.execute(QueryState.forInternalCalls(),QueryOptions.forInternalCalls(consistencyForUser(username),Lists.newArrayList(ByteBufferUtil.bytes(username))));
    result=UntypedResultSet.create(rows.result);
  }
 catch (  RequestValidationException e) {
    throw new AssertionError(e);
  }
catch (  RequestExecutionException e) {
    throw new AuthenticationException(e.toString());
  }
  if (result.isEmpty() || !BCrypt.checkpw(password,result.one().getString(SALTED_HASH)))   throw new AuthenticationException("Username and/or password are incorrect");
  return new AuthenticatedUser(username);
}
