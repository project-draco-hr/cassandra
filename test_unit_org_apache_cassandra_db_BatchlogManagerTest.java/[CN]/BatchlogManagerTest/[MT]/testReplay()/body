{
  long initialAllBatches=BatchlogManager.instance.countAllBatches();
  long initialReplayedBatches=BatchlogManager.instance.getTotalBatchesReplayed();
  CellNameType comparator=Keyspace.open("Keyspace1").getColumnFamilyStore("Standard1").metadata.comparator;
  for (int i=0; i < 1000; i++) {
    Mutation mutation=new Mutation("Keyspace1",bytes(i));
    mutation.add("Standard1",comparator.makeCellName(bytes(i)),bytes(i),System.currentTimeMillis());
    long timestamp=System.currentTimeMillis();
    if (i < 500)     timestamp-=DatabaseDescriptor.getWriteRpcTimeout() * 2;
    BatchlogManager.getBatchlogMutationFor(Collections.singleton(mutation),UUIDGen.getTimeUUID(),MessagingService.current_version,timestamp * 1000).apply();
  }
  Keyspace.open(Keyspace.SYSTEM_KS).getColumnFamilyStore(SystemKeyspace.BATCHLOG_CF).forceBlockingFlush();
  assertEquals(1000,BatchlogManager.instance.countAllBatches() - initialAllBatches);
  assertEquals(0,BatchlogManager.instance.getTotalBatchesReplayed() - initialReplayedBatches);
  BatchlogManager.instance.replayAllFailedBatches();
  assertEquals(500,BatchlogManager.instance.countAllBatches() - initialAllBatches);
  assertEquals(500,BatchlogManager.instance.getTotalBatchesReplayed() - initialReplayedBatches);
  for (int i=0; i < 1000; i++) {
    UntypedResultSet result=QueryProcessor.executeInternal(String.format("SELECT * FROM \"Keyspace1\".\"Standard1\" WHERE key = intAsBlob(%d)",i));
    if (i < 500) {
      assertEquals(bytes(i),result.one().getBytes("key"));
      assertEquals(bytes(i),result.one().getBytes("column1"));
      assertEquals(bytes(i),result.one().getBytes("value"));
    }
 else {
      assertTrue(result.isEmpty());
    }
  }
  UntypedResultSet result=QueryProcessor.executeInternal(String.format("SELECT count(*) FROM \"Keyspace1\".\"Standard1\""));
  assertEquals(500,result.one().getLong("count"));
}
