{
  long initialAllBatches=BatchlogManager.instance.countAllBatches();
  long initialReplayedBatches=BatchlogManager.instance.getTotalBatchesReplayed();
  CFMetaData cfm=Keyspace.open(KEYSPACE1).getColumnFamilyStore(CF_STANDARD1).metadata;
  for (int i=0; i < 1000; i++) {
    Mutation m=new RowUpdateBuilder(cfm,FBUtilities.timestampMicros(),bytes(i)).clustering("name" + i).add("val","val" + i).build();
    long timestamp=i < 500 ? (System.currentTimeMillis() - DatabaseDescriptor.getWriteRpcTimeout() * 2) * 1000 : Long.MAX_VALUE;
    Mutation m2=BatchlogManager.getBatchlogMutationFor(Collections.singleton(m),UUIDGen.getTimeUUID(),MessagingService.current_version,timestamp);
    m2.applyUnsafe();
  }
  Keyspace.open(SystemKeyspace.NAME).getColumnFamilyStore(SystemKeyspace.BATCHLOG).forceBlockingFlush();
  assertEquals(1000,BatchlogManager.instance.countAllBatches() - initialAllBatches);
  assertEquals(0,BatchlogManager.instance.getTotalBatchesReplayed() - initialReplayedBatches);
  BatchlogManager.instance.startBatchlogReplay().get();
  assertEquals(500,BatchlogManager.instance.countAllBatches() - initialAllBatches);
  assertEquals(500,BatchlogManager.instance.getTotalBatchesReplayed() - initialReplayedBatches);
  for (int i=0; i < 1000; i++) {
    UntypedResultSet result=QueryProcessor.executeInternal(String.format("SELECT * FROM \"%s\".\"%s\" WHERE key = intAsBlob(%d)",KEYSPACE1,CF_STANDARD1,i));
    if (i < 500) {
      assertEquals(bytes(i),result.one().getBytes("key"));
      assertEquals("name" + i,result.one().getString("name"));
      assertEquals("val" + i,result.one().getString("val"));
    }
 else {
      assertTrue(result.isEmpty());
    }
  }
  UntypedResultSet result=QueryProcessor.executeInternal(String.format("SELECT count(*) FROM \"%s\".\"%s\"",KEYSPACE1,CF_STANDARD1));
  assertEquals(500,result.one().getLong("count"));
}
