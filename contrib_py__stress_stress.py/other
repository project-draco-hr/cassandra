have_multiproc = False
try:
    from multiprocessing import Array as array, Process as Thread
    from uuid import uuid1 as get_ident
    Thread.isAlive = Thread.is_alive
    have_multiproc = True
except ImportError:
    from threading import Thread
    from thread import get_ident
    from array import array
from hashlib import md5
import time, random, sys, os
from random import randint, gauss
from optparse import OptionParser
from thrift.transport import TTransport
from thrift.transport import TSocket
from thrift.transport import THttpClient
from thrift.protocol import TBinaryProtocol
try:
    from cassandra import Cassandra
    from cassandra.ttypes import *
except ImportError:
    L = os.path.abspath(__file__).split(os.path.sep)[:(-3)]
    root = os.path.sep.join(L)
    _ipath = os.path.join(root, 'interface', 'thrift', 'gen-py')
    sys.path.append(os.path.join(_ipath, 'cassandra'))
    import Cassandra
    from ttypes import *
except ImportError:
    print "Cassandra thrift bindings not found, please run 'ant gen-thrift-py'"
    sys.exit(2)
try:
    from thrift.protocol import fastbinary
except ImportError:
    print 'WARNING: thrift binary extension not found, benchmark will not be accurate!'
parser = OptionParser()
parser.add_option('-n', '--num-keys', type='int', dest='numkeys', help='Number of keys', default=(1000 ** 2))
parser.add_option('-t', '--threads', type='int', dest='threads', help='Number of threads/procs to use', default=50)
parser.add_option('-c', '--columns', type='int', dest='columns', help='Number of columns per key', default=5)
parser.add_option('-d', '--nodes', type='string', dest='nodes', help='Host nodes (comma separated)', default='localhost')
parser.add_option('-s', '--stdev', type='float', dest='stdev', default=0.1, help='standard deviation factor')
parser.add_option('-r', '--random', action='store_true', dest='random', help='use random key generator (stdev will have no effect)')
parser.add_option('-f', '--file', type='string', dest='file', help='write output to file')
parser.add_option('-p', '--port', type='int', default=9160, dest='port', help='thrift port')
parser.add_option('-m', '--framed', action='store_true', dest='framed', help='use framed transport')
parser.add_option('-o', '--operation', type='choice', dest='operation', default='insert', choices=('insert', 'read', 'rangeslice'), help='operation to perform')
parser.add_option('-u', '--supercolumns', type='int', dest='supers', default=1, help='number of super columns per key')
parser.add_option('-y', '--family-type', type='choice', dest='cftype', choices=('regular', 'super'), default='regular', help='column family type')
parser.add_option('-k', '--keep-going', action='store_true', dest='ignore', help='ignore errors inserting or reading')
parser.add_option('-i', '--progress-interval', type='int', default=10, dest='interval', help='progress report interval (seconds)')
parser.add_option('-g', '--get-range-slice-count', type='int', default=1000, dest='rangecount', help='amount of keys to get_range_slices per call')
(options, args) = parser.parse_args()
total_keys = options.numkeys
n_threads = options.threads
keys_per_thread = (total_keys / n_threads)
columns_per_key = options.columns
supers_per_key = options.supers
nodes = options.nodes.split(',')
stdev = (total_keys * options.stdev)
mean = (total_keys / 2)
key_generator = key_generator_gauss
if options.random:
    key_generator = key_generator_random
stresser = Stress()
benchmark = getattr(stresser, options.operation, None)
if (not have_multiproc):
    print 'WARNING: multiprocessing not present, threading will be used.\n        Benchmark may not be accurate!'
if (options.operation == 'insert'):
    make_keyspaces()
benchmark()
