{
  boolean hasCounterColumn=false;
  RowMutation rm=new RowMutation(cfDef.cfm.ksName,key);
  if (cfDef.isCompact) {
    if (builder.componentCount() == 0)     throw new InvalidRequestException(String.format("Missing PRIMARY KEY part %s",cfDef.columns.values().iterator().next()));
    Operation value=processedColumns.get(cfDef.value.name);
    if (value == null)     throw new InvalidRequestException(String.format("Missing mandatory column %s",cfDef.value));
    hasCounterColumn=addToMutation(clientState,rm,builder.build(),cfDef.value,value,variables);
  }
 else {
    for (    CFDefinition.Name name : cfDef.metadata.values()) {
      Operation value=processedColumns.get(name.name);
      if (value == null)       continue;
      ByteBuffer colName=builder.copy().add(name.name.key).build();
      hasCounterColumn|=addToMutation(clientState,rm,colName,name,value,variables);
    }
  }
  return (hasCounterColumn) ? new CounterMutation(rm,getConsistencyLevel()) : rm;
}
