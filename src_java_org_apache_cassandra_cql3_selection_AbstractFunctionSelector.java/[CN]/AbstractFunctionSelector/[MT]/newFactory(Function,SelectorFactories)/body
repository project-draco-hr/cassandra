{
  if (fun.isAggregate()) {
    if (factories.doesAggregation())     throw new InvalidRequestException("aggregate functions cannot be used as arguments of aggregate functions");
  }
 else {
    if (factories.doesAggregation() && !factories.containsOnlyAggregateFunctions())     throw new InvalidRequestException(String.format("arguments of function %s must be either all aggregates or no aggregates",fun.name()));
  }
  return new Factory(){
    protected String getColumnName(){
      return new StrBuilder(fun.name().toString()).append('(').appendWithSeparators(factories.getColumnNames(),", ").append(')').toString();
    }
    protected AbstractType<?> getReturnType(){
      return fun.returnType();
    }
    public boolean usesFunction(    String ksName,    String functionName){
      return fun.usesFunction(ksName,functionName);
    }
    public Iterable<Function> getFunctions(){
      return Iterables.concat(fun.getFunctions(),factories.getFunctions());
    }
    public Selector newInstance() throws InvalidRequestException {
      return fun.isAggregate() ? new AggregateFunctionSelector(fun,factories.newInstances()) : new ScalarFunctionSelector(fun,factories.newInstances());
    }
    public boolean isWritetimeSelectorFactory(){
      return factories.containsWritetimeSelectorFactory();
    }
    public boolean isTTLSelectorFactory(){
      return factories.containsTTLSelectorFactory();
    }
    public boolean isAggregateSelectorFactory(){
      return fun.isAggregate() || factories.containsOnlyAggregateFunctions();
    }
  }
;
}
