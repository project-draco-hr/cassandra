{
  byte[] body=message.getMessageBody();
  ByteArrayInputStream bufIn=new ByteArrayInputStream(body);
  try {
    FileStatus streamStatus=FileStatus.serializer().deserialize(new DataInputStream(bufIn));
    StreamOutSession session=StreamOutSession.get(message.getFrom(),streamStatus.sessionId);
    session.validateCurrentFile(streamStatus.file);
switch (streamStatus.action) {
case FINISHED:
      session.startNext();
    break;
case RETRY:
  logger.warn("Need to re-stream file {} to {}",streamStatus.file,message.getFrom());
session.retry();
break;
default :
throw new RuntimeException("Cannot handle FileStatus.Action: " + streamStatus.action);
}
}
 catch (IOException ex) {
throw new IOError(ex);
}
}
