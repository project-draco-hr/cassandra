{
  ColumnFamilyStore cfs=Keyspace.open(KEYSPACE1).getColumnFamilyStore(CF1);
  cfs.truncateBlocking();
  ColumnFamily cells=ArrayBackedSortedColumns.factory.create(cfs.metadata);
  cells.addCounter(cellname(1),1L);
  cells.addCounter(cellname(2),-1L);
  new CounterMutation(new Mutation(KEYSPACE1,bytes(1),cells),ConsistencyLevel.ONE).apply();
  ColumnFamily current=cfs.getColumnFamily(QueryFilter.getIdentityFilter(dk(bytes(1)),CF1,System.currentTimeMillis()));
  assertEquals(1L,CounterContext.instance().total(current.getColumn(cellname(1)).value()));
  assertEquals(-1L,CounterContext.instance().total(current.getColumn(cellname(2)).value()));
  cells=ArrayBackedSortedColumns.factory.create(cfs.metadata);
  cells.addCounter(cellname(1),2L);
  cells.addCounter(cellname(2),-2L);
  new CounterMutation(new Mutation(KEYSPACE1,bytes(1),cells),ConsistencyLevel.ONE).apply();
  current=cfs.getColumnFamily(QueryFilter.getIdentityFilter(dk(bytes(1)),CF1,System.currentTimeMillis()));
  assertEquals(3L,CounterContext.instance().total(current.getColumn(cellname(1)).value()));
  cells=ArrayBackedSortedColumns.factory.create(cfs.metadata);
  cells.addCounter(cellname(1),-3L);
  cells.addCounter(cellname(2),3L);
  new CounterMutation(new Mutation(KEYSPACE1,bytes(1),cells),ConsistencyLevel.ONE).apply();
  current=cfs.getColumnFamily(QueryFilter.getIdentityFilter(dk(bytes(1)),CF1,System.currentTimeMillis()));
  assertEquals(0L,CounterContext.instance().total(current.getColumn(cellname(1)).value()));
  assertEquals(0L,CounterContext.instance().total(current.getColumn(cellname(2)).value()));
  assertEquals(ClockAndCount.create(3L,0L),cfs.getCachedCounter(bytes(1),cellname(1)));
  assertEquals(ClockAndCount.create(3L,0L),cfs.getCachedCounter(bytes(1),cellname(2)));
}
