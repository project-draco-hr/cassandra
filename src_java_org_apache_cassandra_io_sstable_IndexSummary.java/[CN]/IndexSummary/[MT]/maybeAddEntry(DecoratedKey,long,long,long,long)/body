{
  boolean spannedIndexEntry=DatabaseDescriptor.getIndexAccessMode() == Config.DiskAccessMode.mmap && RowIndexedReader.bufferIndex(indexPosition) != RowIndexedReader.bufferIndex(nextIndexPosition);
  if (keysWritten++ % INDEX_INTERVAL == 0 || spannedIndexEntry) {
    if (indexPositions == null) {
      indexPositions=new ArrayList<KeyPosition>();
    }
    KeyPosition info=new KeyPosition(decoratedKey,indexPosition);
    indexPositions.add(info);
    if (spannedIndexEntry) {
      if (spannedIndexDataPositions == null) {
        spannedIndexDataPositions=new HashMap<KeyPosition,SSTable.PositionSize>();
        spannedIndexPositions=new HashMap<Long,KeyPosition>();
      }
      spannedIndexDataPositions.put(info,new SSTable.PositionSize(dataPosition,dataSize));
      spannedIndexPositions.put(info.indexPosition,info);
    }
  }
  lastIndexPosition=indexPosition;
}
