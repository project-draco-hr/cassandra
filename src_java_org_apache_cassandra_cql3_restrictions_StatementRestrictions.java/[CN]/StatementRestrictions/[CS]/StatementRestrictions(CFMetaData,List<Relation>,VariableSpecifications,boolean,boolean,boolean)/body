{
  this.cfm=cfm;
  this.partitionKeyRestrictions=new PrimaryKeyRestrictionSet(cfm.getKeyValidatorAsCType());
  this.clusteringColumnsRestrictions=new PrimaryKeyRestrictionSet(cfm.comparator);
  this.nonPrimaryKeyRestrictions=new RestrictionSet();
  for (  Relation relation : whereClause)   addRestriction(relation.toRestriction(cfm,boundNames));
  SecondaryIndexManager secondaryIndexManager=Keyspace.open(cfm.ksName).getColumnFamilyStore(cfm.cfName).indexManager;
  boolean hasQueriableClusteringColumnIndex=clusteringColumnsRestrictions.hasSupportingIndex(secondaryIndexManager);
  boolean hasQueriableIndex=hasQueriableClusteringColumnIndex || partitionKeyRestrictions.hasSupportingIndex(secondaryIndexManager) || nonPrimaryKeyRestrictions.hasSupportingIndex(secondaryIndexManager);
  processPartitionKeyRestrictions(hasQueriableIndex);
  if (usesSecondaryIndexing)   indexRestrictions.add(partitionKeyRestrictions);
  checkFalse(selectsOnlyStaticColumns && hasClusteringColumnsRestriction(),"Cannot restrict clustering columns when selecting only static columns");
  processClusteringColumnsRestrictions(hasQueriableIndex,selectACollection);
  if (isKeyRange && hasQueriableClusteringColumnIndex)   usesSecondaryIndexing=true;
  usesSecondaryIndexing=usesSecondaryIndexing || clusteringColumnsRestrictions.isContains();
  if (usesSecondaryIndexing)   indexRestrictions.add(clusteringColumnsRestrictions);
  if (!nonPrimaryKeyRestrictions.isEmpty()) {
    if (!hasQueriableIndex) {
      if (cfm.comparator.isDense() || cfm.comparator.isCompound())       throw invalidRequest("Predicates on non-primary-key columns (%s) are not yet supported for non secondary index queries",Joiner.on(", ").join(toIdentifiers(nonPrimaryKeyRestrictions.getColumnDefs())));
      if (!allowFiltering)       throw invalidRequest(REQUIRES_ALLOW_FILTERING_MESSAGE);
    }
    usesSecondaryIndexing=true;
    indexRestrictions.add(nonPrimaryKeyRestrictions);
  }
  if (usesSecondaryIndexing)   validateSecondaryIndexSelections(selectsOnlyStaticColumns);
}
