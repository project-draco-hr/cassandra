{
  long start=System.nanoTime();
  Memtable mt=getMemtableThreadSafe();
  boolean flushRequested=mt.isThresholdViolated();
  mt.put(key,columnFamily);
  if (rowCache.isPutCopying()) {
    invalidateCachedRow(key);
  }
 else {
    ColumnFamily cachedRow=getRawCachedRow(key);
    if (cachedRow != null)     cachedRow.addAll(columnFamily);
    writeStats.addNano(System.nanoTime() - start);
  }
  if (DatabaseDescriptor.estimatesRealMemtableSize()) {
    while (true) {
      long last=liveRatioComputedAt.get();
      long operations=writeStats.getOpCount();
      if (operations < 2 * last)       break;
      if (liveRatioComputedAt.compareAndSet(last,operations)) {
        logger.debug("computing liveRatio of {} at {} ops",this,operations);
        mt.updateLiveRatio();
      }
    }
  }
  return flushRequested ? mt : null;
}
