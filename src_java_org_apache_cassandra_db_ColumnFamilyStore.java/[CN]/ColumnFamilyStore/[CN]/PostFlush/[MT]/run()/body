{
  writeBarrier.await();
  if (flushSecondaryIndexes)   indexManager.flushAllCustomIndexesBlocking();
  try {
    latch.await();
  }
 catch (  InterruptedException e) {
    throw new IllegalStateException();
  }
  if (lastReplayPosition != null) {
    CommitLog.instance.discardCompletedSegments(metadata.cfId,lastReplayPosition);
  }
  metric.pendingFlushes.dec();
}
